<!DOCTYPE html>
<html>
  <head>
    <title>Hello World</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2020-02-16T13:41:22 AEDT">
<title>C Lecture - 3 :: Hello World</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "\/";
</script>
<meta name="description" content="Exercise 41~ 48">



    
  </head>
  <body data-url="/coding/c/lcthw-lectures.3/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="/">Hello World</a>
  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
  <nav class="shortcuts">
    <div>
      <div class="searchbox">
        <input data-search-input id="search-by" type="text" placeholder="Search...">
      </div>
      <script type="text/javascript" src="/js/lunr.min.js"></script>
      <script type="text/javascript" src="/js/auto-complete.js"></script>
      <link href="/css/auto-complete.css" rel="stylesheet">
      <script type="text/javascript">
        
            var baseurl = "\/";
        
      </script>
      <script type="text/javascript" src="/js/search.js"></script>
    </div>
  </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/projects/" class="dd-item haschildren
        ">
      <div>
      <a href="/projects/">Projects</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/projects/python-flat-api/" class="dd-item">
        <div>
          <a href="/projects/python-flat-api/">
            FlatApi - Restful API for python dev
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/angular4-crm/" class="dd-item">
        <div>
          <a href="/projects/angular4-crm/">
            Angular 4 CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/laravel-mvc-starter/" class="dd-item">
        <div>
          <a href="/projects/laravel-mvc-starter/">
            Laravel MVC Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/react-crm/" class="dd-item">
        <div>
          <a href="/projects/react-crm/">
            React Redux CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/vue2-admin/" class="dd-item">
        <div>
          <a href="/projects/vue2-admin/">
            Vue 2 Admin Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/vue2-crm/" class="dd-item">
        <div>
          <a href="/projects/vue2-crm/">
            Vue 2 CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/angularjs-webpack-es6-starter/" class="dd-item">
        <div>
          <a href="/projects/angularjs-webpack-es6-starter/">
            Angularjs Webpack ES6 Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/zf2-mvc-starter/" class="dd-item">
        <div>
          <a href="/projects/zf2-mvc-starter/">
            Zend Framework 2 MVC Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/kube-cluster/" class="dd-item">
        <div>
          <a href="/projects/kube-cluster/">
            Kubernetes Cluster in 5min
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/coding/">Coding</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/coding/c/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/coding/c/">C </a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/c/lcthw-lectures.1/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.1/">
            C Lecture - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.2/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.2/">
            C Lecture - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.3/" class="dd-item active">
        <div>
          <a href="/coding/c/lcthw-lectures.3/">
            C Lecture - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.4/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.4/">
            C Lecture - 4
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/c-sharp/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/c-sharp/">C#</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/c-sharp/csharp-note-1/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-1/">
            C# Console App
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-4/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-4/">
             Generic Predicate &amp; Expression
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-2/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-2/">
            Scheduled task with window service
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-3/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-3/">
            Thread &amp; Task
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/db-sql/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/db-sql/">DB &amp; SQL</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/db-sql/mysql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-1/">
            MySql Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-2/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-2/">
            MySql Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-3/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-3/">
            MySql Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-4/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-4/">
            MySql Note - 4
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-5/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-5/">
            MySql Note - 5
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/pgsql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/pgsql-note-1/">
            PostgresQL Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mssql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mssql-note-1/">
            Sql Server Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/golang/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/golang/">Golang</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/golang/go-note-1/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-1/">
            Getting started
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-2/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-2/">
            Map, Function &amp; Closure
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-3/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-3/">
            Struct &amp; Interface
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-4/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-4/">
            IO, Json &amp; XML
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-5/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-5/">
            Error handling
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-6/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-6/">
            Goroutine &amp; Channel - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-7/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-7/">
            Goroutine &amp; Channel - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-8/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-8/">
            Packaging
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-9/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-9/">
            Pitfalls
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-10/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-10/">
            Template
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-20/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-20/">
            Good practice - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-21/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-21/">
            Good practice 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-22/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-22/">
            Good practice 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-99/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-99/">
            Golang snippets
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/java/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/java/">Java</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/java/java-note-1/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-1/">
            Java Note - 1: Enum
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-2/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-2/">
            Java Note - 2: Concurrency
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-3/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-3/">
            Java Note - 3: Path and Files
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-4/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-4/">
            Java Note - 4: Date Time 
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-5/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-5/">
            Java Note - 5: Lambda 
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/js-ts/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/js-ts/">JS &amp; TS </a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/js-ts/js-note-1/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-1/">
            JS &amp; ES Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-2/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-2/">
            JS &amp; ES Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-3/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-3/">
            JS &amp; ES Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-99/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-99/">
            JS &amp; ES snippet
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/ts-note-1/" class="dd-item">
        <div>
          <a href="/coding/js-ts/ts-note-1/">
            TypeScript Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/python/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/python/">Python</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/python/python-note-1/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-1/">
            Package &amp; Module
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-2/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-2/">
            Closure &amp; Decorator
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-3/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-3/">
            String &amp; Representation
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-4/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-4/">
            Iteration
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-5/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-5/">
            Inheritance &amp; Polymorphism
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-6/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-6/">
            Collection
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-7/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-7/">
            Exception &amp; Assertion
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-8/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-8/">
            Context
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-9/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-9/">
            ABC
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/rustlang/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/rustlang/">Rustlang</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/rustlang/rust-note-1/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-1/">
            Data Types &amp; Ownership
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-2/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-2/">
            Project, Vector, String &amp; Hashmap
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-3/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-3/">
            Error handling
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-4/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-4/">
            Generic Type &amp; Trait 
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/shell/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/shell/">Shell</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/shell/bash-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-1/">
            Adv Bash - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/bash-note-2/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-2/">
            Adv Bash - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/bash-note-3/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-3/">
            Adv Bash - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/cron-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/cron-note-1/">
            Cron Job Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/cron-note-2/" class="dd-item">
        <div>
          <a href="/coding/shell/cron-note-2/">
            Cron Job Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/ps-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/ps-note-1/">
            Powershell Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cloud/" class="dd-item haschildren
        ">
      <div>
      <a href="/cloud/">Cloud</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cloud/aws-note-1/" class="dd-item">
        <div>
          <a href="/cloud/aws-note-1/">
            AWS Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/aws-note-2/" class="dd-item">
        <div>
          <a href="/cloud/aws-note-2/">
            AWS Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-1/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-1/">
            DigitialOcean Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-2/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-2/">
            DigitialOcean Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-3/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-3/">
            DigitialOcean Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-4/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-4/">
            DigitialOcean Note - 4
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/hacks/" class="dd-item haschildren
        ">
      <div>
      <a href="/hacks/">Hacks</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/hacks/git-notes/" class="dd-item">
        <div>
          <a href="/hacks/git-notes/">
            Git Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-3/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-3/">
            Windows cmd &amp; hotkey - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-2/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-2/">
            Windows cmd &amp; hotkey - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-1/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-1/">
            Windows cmd &amp; hotkey - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/cass-note/" class="dd-item">
        <div>
          <a href="/hacks/cass-note/">
            Cassandra Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/php-debug/" class="dd-item">
        <div>
          <a href="/hacks/php-debug/">
            Debug PHP with Free IDE
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/qemu-notes/" class="dd-item">
        <div>
          <a href="/hacks/qemu-notes/">
            Qemu &amp; Virtual Machine
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/vbox-notes/" class="dd-item">
        <div>
          <a href="/hacks/vbox-notes/">
            VirtualBox Notes
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/os/" class="dd-item haschildren
        ">
      <div>
      <a href="/os/">OS</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/os/dual-boot-win10-ubuntu18/" class="dd-item">
        <div>
          <a href="/os/dual-boot-win10-ubuntu18/">
            Dual Boot Windows 10 &amp; Ubuntu 18
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-18/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-18/">
            Ubuntu Desktop 18 LTS note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/raspberrypi-notes/" class="dd-item">
        <div>
          <a href="/os/raspberrypi-notes/">
            Raspberry Pi setup
          </a>
        </div>
    </li>
      <li data-nav-id="/os/lubuntu16-desktop/" class="dd-item">
        <div>
          <a href="/os/lubuntu16-desktop/">
            Lubuntu 16 desktop
          </a>
        </div>
    </li>
      <li data-nav-id="/os/grub-trouble-shooting/" class="dd-item">
        <div>
          <a href="/os/grub-trouble-shooting/">
            Grub Trouble Shooting
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-server-16/" class="dd-item">
        <div>
          <a href="/os/ubuntu-server-16/">
            Ubuntu 16 server note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/centos-server-7/" class="dd-item">
        <div>
          <a href="/os/centos-server-7/">
            CentOS 7 Server note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-server-14/" class="dd-item">
        <div>
          <a href="/os/ubuntu-server-14/">
            Ubuntu 14 -- server setup
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-14/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-14/">
            Ubuntu 14 -- desktop setup &amp; dual boot 
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-14-extra-tools/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-14-extra-tools/">
            Ubuntu 14 -- desktop, extra tools
          </a>
        </div>
    </li>
      <li data-nav-id="/os/centos-fedora-desktop/" class="dd-item">
        <div>
          <a href="/os/centos-fedora-desktop/">
            CentOS 6/7 Multi-Boot Setup
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blogs/" class="dd-item haschildren
        ">
      <div>
      <a href="/blogs/">Blogs</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blogs/k8s-on-vm/" class="dd-item">
        <div>
          <a href="/blogs/k8s-on-vm/">
            Try Minikube
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/vue-ng-react/" class="dd-item">
        <div>
          <a href="/blogs/vue-ng-react/">
            Angular vs React vs Vue
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/create-a-blog-on-github/" class="dd-item">
        <div>
          <a href="/blogs/create-a-blog-on-github/">
            Create a blog site on GitHub Pages
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/build-mobile-app/" class="dd-item">
        <div>
          <a href="/blogs/build-mobile-app/">
            Build mobile app with web tech
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/azure-notes/" class="dd-item">
        <div>
          <a href="/blogs/azure-notes/">
            Azure Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/javascript-oop/" class="dd-item">
        <div>
          <a href="/blogs/javascript-oop/">
            JavaScript and OOP
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/frameworks/" class="dd-item haschildren
        ">
      <div>
      <a href="/frameworks/">Frameworks</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/frameworks/cntk-notes-1/" class="dd-item">
        <div>
          <a href="/frameworks/cntk-notes-1/">
            CNTK Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/tensorflow-notes-1/" class="dd-item">
        <div>
          <a href="/frameworks/tensorflow-notes-1/">
            Tensorflow Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/tensorflow-notes-2/" class="dd-item">
        <div>
          <a href="/frameworks/tensorflow-notes-2/">
            Tensorflow Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/php-web/" class="dd-item">
        <div>
          <a href="/frameworks/php-web/">
            PHP Web Framework
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/python-django/" class="dd-item">
        <div>
          <a href="/frameworks/python-django/">
            Python Web Framework
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/tut/" class="dd-item haschildren
        ">
      <div>
      <a href="/tut/">Tutorial</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/tut/docker/" class="dd-item">
        <div>
          <a href="/tut/docker/">
            Docker Tutorial
          </a>
        </div>
    </li>
      <li data-nav-id="/tut/javascript/" class="dd-item">
        <div>
          <a href="/tut/javascript/">
            JavaScript Tutorial
          </a>
        </div>
    </li>
      <li data-nav-id="/tut/kube/" class="dd-item">
        <div>
          <a href="/tut/kube/">
            Kubernetes Tutorial
          </a>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/projects/" >
   Projects</option>
    <option value="/coding/" >
   Coding</option> 
    <option value="/coding/c/" >
  - 
   C </option> 
      <option value="/coding/c/lcthw-lectures.1/" >-- C Lecture - 1</option>
      <option value="/coding/c/lcthw-lectures.2/" >-- C Lecture - 2</option>
      <option value="/coding/c/lcthw-lectures.3/"  selected>-- C Lecture - 3</option>
      <option value="/coding/c/lcthw-lectures.4/" >-- C Lecture - 4</option>
  
    <option value="/coding/c-sharp/" >
  - 
   C#</option>
    <option value="/coding/db-sql/" >
  - 
   DB &amp; SQL</option>
    <option value="/coding/golang/" >
  - 
   Golang</option>
    <option value="/coding/java/" >
  - 
   Java</option>
    <option value="/coding/js-ts/" >
  - 
   JS &amp; TS </option>
    <option value="/coding/python/" >
  - 
   Python</option>
    <option value="/coding/rustlang/" >
  - 
   Rustlang</option>
    <option value="/coding/shell/" >
  - 
   Shell</option>
  
    <option value="/cloud/" >
   Cloud</option>
    <option value="/hacks/" >
   Hacks</option>
    <option value="/os/" >
   OS</option>
    <option value="/blogs/" >
   Blogs</option>
    <option value="/frameworks/" >
   Frameworks</option>
    <option value="/tut/" >
   Tutorial</option>



        </select>
      </center>
    </div>


    


    
    
    
<div class="main-page">
    <div class="flex-item main-content">
            <h1>C Lecture - 3</h1>
        <p>Author: Zed A. Shaw</p>
<p>All content comes from Zed's <a href="https://github.com/zedshaw/learn-c-the-hard-way-lectures.git">Lecture Repository</a> and <a href="https://github.com/zedshaw/liblcthw">Libraries Repository</a>.  All credit goes to Zed.</p>
<h3 id="exercise-41-project-devpkg">Exercise 41 Project devpkg</h3>
<p>.\ex41\devpkg</p>
<p>.\ex41\devpkg\commands.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_uri.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_fnmatch.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;commands.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;bstrlib.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;shell.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_depends</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path)
{
    FILE <span style="color:#f92672">*</span>in <span style="color:#f92672">=</span> NULL;
    bstring line <span style="color:#f92672">=</span> NULL;

    in <span style="color:#f92672">=</span> fopen(path, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>);
    check(in <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open downloaded depends: %s</span><span style="color:#e6db74">&#34;</span>, path);

    <span style="color:#66d9ef">for</span> (line <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, in, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>);
            line <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; 
            line <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, in, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>)) 
    {
        btrimws(line);
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Processing depends: %s</span><span style="color:#e6db74">&#34;</span>, bdata(line));
        <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> Command_install(p, bdata(line), NULL, NULL, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to install: %s</span><span style="color:#e6db74">&#34;</span>, bdata(line));
        bdestroy(line);
    }

    fclose(in);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">if</span> (line) bdestroy(line);
    <span style="color:#66d9ef">if</span> (in) fclose(in);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_fetch</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url, <span style="color:#66d9ef">int</span> fetch_only)
{
    apr_uri_t info <span style="color:#f92672">=</span> {.port <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> };
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>depends_file <span style="color:#f92672">=</span> NULL;
    apr_status_t rv <span style="color:#f92672">=</span> apr_uri_parse(p, url, <span style="color:#f92672">&amp;</span>info);

    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse URL: %s</span><span style="color:#e6db74">&#34;</span>, url);

    <span style="color:#66d9ef">if</span> (apr_fnmatch(GIT_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        rc <span style="color:#f92672">=</span> Shell_exec(GIT_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git failed.</span><span style="color:#e6db74">&#34;</span>);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(DEPEND_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        check(<span style="color:#f92672">!</span>fetch_only, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No point in fetching a DEPENDS file.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#66d9ef">if</span> (info.scheme) {
            depends_file <span style="color:#f92672">=</span> DEPENDS_PATH;
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, depends_file,
                    NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Curl failed.</span><span style="color:#e6db74">&#34;</span>);
        } <span style="color:#66d9ef">else</span> {
            depends_file <span style="color:#f92672">=</span> info.path;
        }

        <span style="color:#75715e">// recursively process the devpkg list
</span><span style="color:#75715e"></span>        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Building according to DEPENDS: %s</span><span style="color:#e6db74">&#34;</span>, url);
        rv <span style="color:#f92672">=</span> Command_depends(p, depends_file);
        check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process the DEPENDS: %s</span><span style="color:#e6db74">&#34;</span>, url);

        <span style="color:#75715e">// this indicates that nothing needs to be done
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(TAR_GZ_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        <span style="color:#66d9ef">if</span> (info.scheme) {
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC, NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to curl source: %s</span><span style="color:#e6db74">&#34;</span>, url);
        }

        rv <span style="color:#f92672">=</span> apr_dir_make_recursive(BUILD_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE <span style="color:#f92672">|</span>
                APR_UEXECUTE, p);
        check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make directory %s</span><span style="color:#e6db74">&#34;</span>,
                BUILD_DIR);

        rc <span style="color:#f92672">=</span> Shell_exec(TAR_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to untar %s</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(TAR_BZ2_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        <span style="color:#66d9ef">if</span> (info.scheme) {
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC,
                    NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Curl failed.</span><span style="color:#e6db74">&#34;</span>);
        }

        apr_status_t rc <span style="color:#f92672">=</span> apr_dir_make_recursive(BUILD_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE
                <span style="color:#f92672">|</span> APR_UEXECUTE, p);

        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make directory %s</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);
        rc <span style="color:#f92672">=</span> Shell_exec(TAR_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to untar %s</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC);
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Don&#39;t now how to handle %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    <span style="color:#75715e">// indicates that an install needs to actually run
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_build</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    check(access(BUILD_DIR, X_OK <span style="color:#f92672">|</span> R_OK <span style="color:#f92672">|</span> W_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Build directory doesn&#39;t exist: %s</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);

    <span style="color:#75715e">// actually do an install
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (access(CONFIG_SCRIPT, X_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Has a configure script, running it.</span><span style="color:#e6db74">&#34;</span>);
        rc <span style="color:#f92672">=</span> Shell_exec(CONFIGURE_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, configure_opts, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to configure.</span><span style="color:#e6db74">&#34;</span>);
    }

    rc <span style="color:#f92672">=</span> Shell_exec(MAKE_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, make_opts, NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to build.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> Shell_exec(INSTALL_SH,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, install_opts <span style="color:#f92672">?</span> install_opts : <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">install</span><span style="color:#e6db74">&#34;</span>,
            NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to install.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> Shell_exec(CLEANUP_SH, NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to cleanup after build.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> DB_update(url);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add this package to the database.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_install</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    check(Shell_exec(CLEANUP_SH, NULL) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to cleanup before building.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> DB_find(url);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Error checking the install database.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Package %s already installed.</span><span style="color:#e6db74">&#34;</span>, url);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }

    rc <span style="color:#f92672">=</span> Command_fetch(p, url, <span style="color:#ae81ff">0</span>);

    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
        rc <span style="color:#f92672">=</span> Command_build(p, url, configure_opts, make_opts,
                install_opts);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to build: %s</span><span style="color:#e6db74">&#34;</span>, url);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// no install needed
</span><span style="color:#75715e"></span>        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Depends successfully installed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// had an error
</span><span style="color:#75715e"></span>        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Install failed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    Shell_exec(CLEANUP_SH, NULL);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    Shell_exec(CLEANUP_SH, NULL);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\commands.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _commands_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _commands_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_pools.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define DEPENDS_PATH &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">DEPENDS&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_GZ_SRC &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-src.tar.gz&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_BZ2_SRC &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-src.tar.bz2&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define BUILD_DIR &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-build&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define GIT_PAT &#34;*.git&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define DEPEND_PAT &#34;*DEPENDS&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_GZ_PAT &#34;*.tar.gz&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_BZ2_PAT &#34;*.tar.bz2&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define CONFIG_SCRIPT &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-build</span><span style="color:#75715e">/</span><span style="color:#75715e">configure&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">enum</span> CommandType {
    COMMAND_NONE, COMMAND_INSTALL, COMMAND_LIST, COMMAND_FETCH,
    COMMAND_INIT, COMMAND_BUILD
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_fetch</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url, <span style="color:#66d9ef">int</span> fetch_only);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_install</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_depends</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_build</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\db.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_file_io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;bstrlib.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> FILE <span style="color:#f92672">*</span><span style="color:#a6e22e">DB_open</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mode)
{
    <span style="color:#66d9ef">return</span> fopen(path, mode);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">DB_close</span>(FILE <span style="color:#f92672">*</span> db)
{
    fclose(db);
}

<span style="color:#66d9ef">static</span> bstring <span style="color:#a6e22e">DB_load</span>()
{
    FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> NULL;
    bstring data <span style="color:#f92672">=</span> NULL;

    db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>);
    check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open database: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    data <span style="color:#f92672">=</span> bread((bNread) fread, db);
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from db file: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    DB_close(db);
    <span style="color:#66d9ef">return</span> data;

error:
    <span style="color:#66d9ef">if</span> (db)
        DB_close(db);
    <span style="color:#66d9ef">if</span> (data)
        bdestroy(data);
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_update</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url)
{
    <span style="color:#66d9ef">if</span> (DB_find(url)) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Already recorded as installed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">a+</span><span style="color:#e6db74">&#34;</span>);
    check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open DB file: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    bstring line <span style="color:#f92672">=</span> bfromcstr(url);
    bconchar(line, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>);
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fwrite(line<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data, blength(line), <span style="color:#ae81ff">1</span>, db);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to append to the db.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">if</span> (db)
        DB_close(db);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_find</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url)
{
    bstring data <span style="color:#f92672">=</span> NULL;
    bstring line <span style="color:#f92672">=</span> bfromcstr(url);
    <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    data <span style="color:#f92672">=</span> DB_load();
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to load: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    <span style="color:#66d9ef">if</span> (binstr(data, <span style="color:#ae81ff">0</span>, line) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_ERR) {
        res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        res <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    }

error:            <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (data)
        bdestroy(data);
    <span style="color:#66d9ef">if</span> (line)
        bdestroy(line);

    <span style="color:#66d9ef">return</span> res;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_init</span>()
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    apr_pool_initialize();
    apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);

    <span style="color:#66d9ef">if</span> (access(DB_DIR, W_OK <span style="color:#f92672">|</span> X_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        apr_status_t rc <span style="color:#f92672">=</span> apr_dir_make_recursive(DB_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE
                <span style="color:#f92672">|</span> APR_UEXECUTE <span style="color:#f92672">|</span>
                APR_GREAD <span style="color:#f92672">|</span> APR_GWRITE
                <span style="color:#f92672">|</span> APR_GEXECUTE, p);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make database dir: %s</span><span style="color:#e6db74">&#34;</span>,
                DB_DIR);
    }

    <span style="color:#66d9ef">if</span> (access(DB_FILE, W_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">w</span><span style="color:#e6db74">&#34;</span>);
        check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot open database: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);
        DB_close(db);
    }

    apr_pool_destroy(p);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    apr_pool_destroy(p);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_list</span>()
{
    bstring data <span style="color:#f92672">=</span> DB_load();
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read load: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>, bdata(data));
    bdestroy(data);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\db.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _db_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _db_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define DB_FILE &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">usr</span><span style="color:#75715e">/</span><span style="color:#75715e">local</span><span style="color:#75715e">/</span><span style="color:#75715e">.devpkg</span><span style="color:#75715e">/</span><span style="color:#75715e">db&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define DB_DIR &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">usr</span><span style="color:#75715e">/</span><span style="color:#75715e">local</span><span style="color:#75715e">/</span><span style="color:#75715e">.devpkg&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_init</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_list</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_update</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_find</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\devpkg.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_general.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_getopt.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_strings.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_lib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;commands.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    apr_pool_initialize();
    apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);

    apr_getopt_t <span style="color:#f92672">*</span>opt;
    apr_status_t rv;

    <span style="color:#66d9ef">char</span> ch <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>optarg <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>config_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">enum</span> CommandType request <span style="color:#f92672">=</span> COMMAND_NONE;

    rv <span style="color:#f92672">=</span> apr_getopt_init(<span style="color:#f92672">&amp;</span>opt, p, argc, argv);

    <span style="color:#66d9ef">while</span> (apr_getopt(opt, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">I:Lc:m:i:d:SF:B:</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>ch, <span style="color:#f92672">&amp;</span>optarg) <span style="color:#f92672">=</span><span style="color:#f92672">=</span>
            APR_SUCCESS) {
        <span style="color:#66d9ef">switch</span> (ch) {
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">I</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_INSTALL;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">L</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_LIST;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">c</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                config_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">m</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                make_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">i</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                install_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_INIT;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">F</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_FETCH;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">B</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_BUILD;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#66d9ef">switch</span> (request) {
        <span style="color:#66d9ef">case</span> COMMAND_INSTALL:
            check(url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must at least give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_install(p, url, config_opts, make_opts, install_opts);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_LIST:
            DB_list();
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_FETCH:
            check(url <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_fetch(p, url, <span style="color:#ae81ff">1</span>);
            log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Downloaded to %s and in /tmp/</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_BUILD:
            check(url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must at least give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_build(p, url, config_opts, make_opts, install_opts);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_INIT:
            rv <span style="color:#f92672">=</span> DB_init();
            check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make the database.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid command given.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\shell.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;shell.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdarg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_exec</span>(Shell template, ...)
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    apr_status_t rv <span style="color:#f92672">=</span> APR_SUCCESS;
    va_list argp;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>arg <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rv <span style="color:#f92672">=</span> apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create pool.</span><span style="color:#e6db74">&#34;</span>);

    va_start(argp, template);

    <span style="color:#66d9ef">for</span> (key <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);
            key <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; key <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)) {
        arg <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; template.args[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">if</span> (strcmp(template.args[i], key) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
                template.args[i] <span style="color:#f92672">=</span> arg;
                <span style="color:#66d9ef">break</span>;        <span style="color:#75715e">// found it
</span><span style="color:#75715e"></span>            }
        }
    }

    rc <span style="color:#f92672">=</span> Shell_run(p, <span style="color:#f92672">&amp;</span>template);
    apr_pool_destroy(p);
    va_end(argp);
    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">if</span> (p) {
        apr_pool_destroy(p);
    }
    <span style="color:#66d9ef">return</span> rc;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_run</span>(apr_pool_t <span style="color:#f92672">*</span> p, Shell <span style="color:#f92672">*</span> cmd)
{
    apr_procattr_t <span style="color:#f92672">*</span>attr;
    apr_status_t rv;
    apr_proc_t newproc;

    rv <span style="color:#f92672">=</span> apr_procattr_create(<span style="color:#f92672">&amp;</span>attr, p);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create proc attr.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_procattr_io_set(attr, APR_NO_PIPE, APR_NO_PIPE,
            APR_NO_PIPE);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set IO of command.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_procattr_dir_set(attr, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>dir);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set root to %s</span><span style="color:#e6db74">&#34;</span>, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>dir);

    rv <span style="color:#f92672">=</span> apr_procattr_cmdtype_set(attr, APR_PROGRAM_PATH);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set cmd type.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_proc_create(<span style="color:#f92672">&amp;</span>newproc, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>args, NULL, attr, p);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run command.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_proc_wait(<span style="color:#f92672">&amp;</span>newproc, <span style="color:#f92672">&amp;</span>cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_code, <span style="color:#f92672">&amp;</span>cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_why,
            APR_WAIT);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_CHILD_DONE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to wait.</span><span style="color:#e6db74">&#34;</span>);

    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_code <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s exited badly.</span><span style="color:#e6db74">&#34;</span>, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe);
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_why <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_PROC_EXIT, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s was killed or crashed</span><span style="color:#e6db74">&#34;</span>,
            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

Shell CLEANUP_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rm</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rm</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-rf</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-src.tar.gz</span><span style="color:#e6db74">&#34;</span>,
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-src.tar.bz2</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/DEPENDS</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell GIT_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">clone</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pkg-build</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell TAR_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tar</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tar</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-xzf</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">--strip-components</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell CURL_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">curl</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">curl</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-L</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-o</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell CONFIGURE_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">./configure</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">configure</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, NULL}
    ,
};

Shell MAKE_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell INSTALL_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sudo</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sudo</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, NULL}
};

</code></pre></div><p>.\ex41\devpkg\shell.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _shell_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _shell_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define MAX_COMMAND_ARGS 100</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_thread_proc.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Shell {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>dir;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>exe;

    apr_procattr_t <span style="color:#f92672">*</span>attr;
    apr_proc_t proc;
    apr_exit_why_e exit_why;
    <span style="color:#66d9ef">int</span> exit_code;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>args[MAX_COMMAND_ARGS];
} Shell;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_run</span>(apr_pool_t <span style="color:#f92672">*</span> p, Shell <span style="color:#f92672">*</span> cmd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_exec</span>(Shell cmd, ...);

<span style="color:#66d9ef">extern</span> Shell CLEANUP_SH;
<span style="color:#66d9ef">extern</span> Shell GIT_SH;
<span style="color:#66d9ef">extern</span> Shell TAR_SH;
<span style="color:#66d9ef">extern</span> Shell CURL_SH;
<span style="color:#66d9ef">extern</span> Shell CONFIGURE_SH;
<span style="color:#66d9ef">extern</span> Shell MAKE_SH;
<span style="color:#66d9ef">extern</span> Shell INSTALL_SH;

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\ex41.1.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">set -e

<span style="color:#75715e">## go somewhere safe</span>
cd /tmp

<span style="color:#75715e">## get the source to base APR 1.5.2</span>
curl -L -O http://archive.apache.org/dist/apr/apr-1.5.2.tar.gz

<span style="color:#75715e">## extract it and go into the source</span>
tar -xzvf apr-1.5.2.tar.gz
cd apr-1.5.2

<span style="color:#75715e">## you need this on OSX Yosemite</span>
touch libtoolT

<span style="color:#75715e">## configure, make, make install</span>
./configure
make
sudo make install

<span style="color:#75715e">## reset and cleanup</span>
cd /tmp
rm -rf apr-1.5.2 apr-1.5.2.tar.gz

<span style="color:#75715e">## do the same with apr-util</span>
curl -L -O http://archive.apache.org/dist/apr/apr-util-1.5.4.tar.gz

<span style="color:#75715e">## extract</span>
tar -xzvf apr-util-1.5.4.tar.gz
cd apr-util-1.5.4

<span style="color:#75715e">## you need this on OSX Yosemite</span>
touch libtoolT

<span style="color:#75715e">## configure, make, make install</span>
./configure --with-apr<span style="color:#f92672">=</span>/usr/local/apr
<span style="color:#75715e">## you need that extra parameter to configure because</span>
<span style="color:#75715e">## apr-util can&#39;t really find it because...who knows.</span>

make
sudo make install

<span style="color:#75715e">#cleanup</span>
cd /tmp
rm -rf apr-util-1.5.4* apr-1.5.2*

</code></pre></div><p>.\ex41\ex41.2.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir devpkg
cd devpkg
touch README Makefile

</code></pre></div><p>.\ex41\devpkg</p>
<p>.\ex41\devpkg\commands.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_uri.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_fnmatch.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;commands.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;bstrlib.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;shell.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_depends</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path)
{
    FILE <span style="color:#f92672">*</span>in <span style="color:#f92672">=</span> NULL;
    bstring line <span style="color:#f92672">=</span> NULL;

    in <span style="color:#f92672">=</span> fopen(path, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>);
    check(in <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open downloaded depends: %s</span><span style="color:#e6db74">&#34;</span>, path);

    <span style="color:#66d9ef">for</span> (line <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, in, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>);
            line <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; 
            line <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, in, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>)) 
    {
        btrimws(line);
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Processing depends: %s</span><span style="color:#e6db74">&#34;</span>, bdata(line));
        <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> Command_install(p, bdata(line), NULL, NULL, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to install: %s</span><span style="color:#e6db74">&#34;</span>, bdata(line));
        bdestroy(line);
    }

    fclose(in);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">if</span> (line) bdestroy(line);
    <span style="color:#66d9ef">if</span> (in) fclose(in);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_fetch</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url, <span style="color:#66d9ef">int</span> fetch_only)
{
    apr_uri_t info <span style="color:#f92672">=</span> {.port <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> };
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>depends_file <span style="color:#f92672">=</span> NULL;
    apr_status_t rv <span style="color:#f92672">=</span> apr_uri_parse(p, url, <span style="color:#f92672">&amp;</span>info);

    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse URL: %s</span><span style="color:#e6db74">&#34;</span>, url);

    <span style="color:#66d9ef">if</span> (apr_fnmatch(GIT_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        rc <span style="color:#f92672">=</span> Shell_exec(GIT_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git failed.</span><span style="color:#e6db74">&#34;</span>);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(DEPEND_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        check(<span style="color:#f92672">!</span>fetch_only, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No point in fetching a DEPENDS file.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#66d9ef">if</span> (info.scheme) {
            depends_file <span style="color:#f92672">=</span> DEPENDS_PATH;
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, depends_file,
                    NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Curl failed.</span><span style="color:#e6db74">&#34;</span>);
        } <span style="color:#66d9ef">else</span> {
            depends_file <span style="color:#f92672">=</span> info.path;
        }

        <span style="color:#75715e">// recursively process the devpkg list
</span><span style="color:#75715e"></span>        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Building according to DEPENDS: %s</span><span style="color:#e6db74">&#34;</span>, url);
        rv <span style="color:#f92672">=</span> Command_depends(p, depends_file);
        check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process the DEPENDS: %s</span><span style="color:#e6db74">&#34;</span>, url);

        <span style="color:#75715e">// this indicates that nothing needs to be done
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(TAR_GZ_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        <span style="color:#66d9ef">if</span> (info.scheme) {
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC, NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to curl source: %s</span><span style="color:#e6db74">&#34;</span>, url);
        }

        rv <span style="color:#f92672">=</span> apr_dir_make_recursive(BUILD_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE <span style="color:#f92672">|</span>
                APR_UEXECUTE, p);
        check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make directory %s</span><span style="color:#e6db74">&#34;</span>,
                BUILD_DIR);

        rc <span style="color:#f92672">=</span> Shell_exec(TAR_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to untar %s</span><span style="color:#e6db74">&#34;</span>, TAR_GZ_SRC);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (apr_fnmatch(TAR_BZ2_PAT, info.path, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS) {
        <span style="color:#66d9ef">if</span> (info.scheme) {
            rc <span style="color:#f92672">=</span> Shell_exec(CURL_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC,
                    NULL);
            check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Curl failed.</span><span style="color:#e6db74">&#34;</span>);
        }

        apr_status_t rc <span style="color:#f92672">=</span> apr_dir_make_recursive(BUILD_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE
                <span style="color:#f92672">|</span> APR_UEXECUTE, p);

        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make directory %s</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);
        rc <span style="color:#f92672">=</span> Shell_exec(TAR_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to untar %s</span><span style="color:#e6db74">&#34;</span>, TAR_BZ2_SRC);
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Don&#39;t now how to handle %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    <span style="color:#75715e">// indicates that an install needs to actually run
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_build</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    check(access(BUILD_DIR, X_OK <span style="color:#f92672">|</span> R_OK <span style="color:#f92672">|</span> W_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Build directory doesn&#39;t exist: %s</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);

    <span style="color:#75715e">// actually do an install
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (access(CONFIG_SCRIPT, X_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Has a configure script, running it.</span><span style="color:#e6db74">&#34;</span>);
        rc <span style="color:#f92672">=</span> Shell_exec(CONFIGURE_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, configure_opts, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to configure.</span><span style="color:#e6db74">&#34;</span>);
    }

    rc <span style="color:#f92672">=</span> Shell_exec(MAKE_SH, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, make_opts, NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to build.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> Shell_exec(INSTALL_SH,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, install_opts <span style="color:#f92672">?</span> install_opts : <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">install</span><span style="color:#e6db74">&#34;</span>,
            NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to install.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> Shell_exec(CLEANUP_SH, NULL);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to cleanup after build.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> DB_update(url);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add this package to the database.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_install</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    check(Shell_exec(CLEANUP_SH, NULL) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to cleanup before building.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> DB_find(url);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Error checking the install database.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Package %s already installed.</span><span style="color:#e6db74">&#34;</span>, url);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }

    rc <span style="color:#f92672">=</span> Command_fetch(p, url, <span style="color:#ae81ff">0</span>);

    <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
        rc <span style="color:#f92672">=</span> Command_build(p, url, configure_opts, make_opts,
                install_opts);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to build: %s</span><span style="color:#e6db74">&#34;</span>, url);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// no install needed
</span><span style="color:#75715e"></span>        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Depends successfully installed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// had an error
</span><span style="color:#75715e"></span>        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Install failed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    Shell_exec(CLEANUP_SH, NULL);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    Shell_exec(CLEANUP_SH, NULL);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\commands.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _commands_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _commands_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_pools.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define DEPENDS_PATH &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">DEPENDS&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_GZ_SRC &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-src.tar.gz&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_BZ2_SRC &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-src.tar.bz2&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define BUILD_DIR &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-build&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define GIT_PAT &#34;*.git&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define DEPEND_PAT &#34;*DEPENDS&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_GZ_PAT &#34;*.tar.gz&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TAR_BZ2_PAT &#34;*.tar.bz2&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define CONFIG_SCRIPT &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">tmp</span><span style="color:#75715e">/</span><span style="color:#75715e">pkg-build</span><span style="color:#75715e">/</span><span style="color:#75715e">configure&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">enum</span> CommandType {
    COMMAND_NONE, COMMAND_INSTALL, COMMAND_LIST, COMMAND_FETCH,
    COMMAND_INIT, COMMAND_BUILD
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_fetch</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url, <span style="color:#66d9ef">int</span> fetch_only);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_install</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_depends</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Command_build</span>(apr_pool_t <span style="color:#f92672">*</span> p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>configure_opts, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\db.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_file_io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;bstrlib.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> FILE <span style="color:#f92672">*</span><span style="color:#a6e22e">DB_open</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mode)
{
    <span style="color:#66d9ef">return</span> fopen(path, mode);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">DB_close</span>(FILE <span style="color:#f92672">*</span> db)
{
    fclose(db);
}

<span style="color:#66d9ef">static</span> bstring <span style="color:#a6e22e">DB_load</span>()
{
    FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> NULL;
    bstring data <span style="color:#f92672">=</span> NULL;

    db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>);
    check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open database: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    data <span style="color:#f92672">=</span> bread((bNread) fread, db);
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from db file: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    DB_close(db);
    <span style="color:#66d9ef">return</span> data;

error:
    <span style="color:#66d9ef">if</span> (db)
        DB_close(db);
    <span style="color:#66d9ef">if</span> (data)
        bdestroy(data);
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_update</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url)
{
    <span style="color:#66d9ef">if</span> (DB_find(url)) {
        log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Already recorded as installed: %s</span><span style="color:#e6db74">&#34;</span>, url);
    }

    FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">a+</span><span style="color:#e6db74">&#34;</span>);
    check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open DB file: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    bstring line <span style="color:#f92672">=</span> bfromcstr(url);
    bconchar(line, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>);
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fwrite(line<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data, blength(line), <span style="color:#ae81ff">1</span>, db);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to append to the db.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">if</span> (db)
        DB_close(db);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_find</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url)
{
    bstring data <span style="color:#f92672">=</span> NULL;
    bstring line <span style="color:#f92672">=</span> bfromcstr(url);
    <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    data <span style="color:#f92672">=</span> DB_load();
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to load: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    <span style="color:#66d9ef">if</span> (binstr(data, <span style="color:#ae81ff">0</span>, line) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_ERR) {
        res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        res <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    }

error:            <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (data)
        bdestroy(data);
    <span style="color:#66d9ef">if</span> (line)
        bdestroy(line);

    <span style="color:#66d9ef">return</span> res;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_init</span>()
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    apr_pool_initialize();
    apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);

    <span style="color:#66d9ef">if</span> (access(DB_DIR, W_OK <span style="color:#f92672">|</span> X_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        apr_status_t rc <span style="color:#f92672">=</span> apr_dir_make_recursive(DB_DIR,
                APR_UREAD <span style="color:#f92672">|</span> APR_UWRITE
                <span style="color:#f92672">|</span> APR_UEXECUTE <span style="color:#f92672">|</span>
                APR_GREAD <span style="color:#f92672">|</span> APR_GWRITE
                <span style="color:#f92672">|</span> APR_GEXECUTE, p);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make database dir: %s</span><span style="color:#e6db74">&#34;</span>,
                DB_DIR);
    }

    <span style="color:#66d9ef">if</span> (access(DB_FILE, W_OK) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        FILE <span style="color:#f92672">*</span>db <span style="color:#f92672">=</span> DB_open(DB_FILE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">w</span><span style="color:#e6db74">&#34;</span>);
        check(db, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot open database: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);
        DB_close(db);
    }

    apr_pool_destroy(p);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    apr_pool_destroy(p);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_list</span>()
{
    bstring data <span style="color:#f92672">=</span> DB_load();
    check(data, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read load: %s</span><span style="color:#e6db74">&#34;</span>, DB_FILE);

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>, bdata(data));
    bdestroy(data);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\db.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _db_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _db_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define DB_FILE &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">usr</span><span style="color:#75715e">/</span><span style="color:#75715e">local</span><span style="color:#75715e">/</span><span style="color:#75715e">.devpkg</span><span style="color:#75715e">/</span><span style="color:#75715e">db&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define DB_DIR &#34;</span><span style="color:#75715e">/</span><span style="color:#75715e">usr</span><span style="color:#75715e">/</span><span style="color:#75715e">local</span><span style="color:#75715e">/</span><span style="color:#75715e">.devpkg&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_init</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_list</span>();
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_update</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">DB_find</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\devpkg\devpkg.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_general.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_getopt.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_strings.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_lib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;db.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;commands.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    apr_pool_initialize();
    apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);

    apr_getopt_t <span style="color:#f92672">*</span>opt;
    apr_status_t rv;

    <span style="color:#66d9ef">char</span> ch <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>optarg <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>config_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>install_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>make_opts <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>url <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">enum</span> CommandType request <span style="color:#f92672">=</span> COMMAND_NONE;

    rv <span style="color:#f92672">=</span> apr_getopt_init(<span style="color:#f92672">&amp;</span>opt, p, argc, argv);

    <span style="color:#66d9ef">while</span> (apr_getopt(opt, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">I:Lc:m:i:d:SF:B:</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>ch, <span style="color:#f92672">&amp;</span>optarg) <span style="color:#f92672">=</span><span style="color:#f92672">=</span>
            APR_SUCCESS) {
        <span style="color:#66d9ef">switch</span> (ch) {
            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">I</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_INSTALL;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">L</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_LIST;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">c</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                config_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">m</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                make_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">i</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                install_opts <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_INIT;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">F</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_FETCH;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">B</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">:</span>
                request <span style="color:#f92672">=</span> COMMAND_BUILD;
                url <span style="color:#f92672">=</span> optarg;
                <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#66d9ef">switch</span> (request) {
        <span style="color:#66d9ef">case</span> COMMAND_INSTALL:
            check(url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must at least give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_install(p, url, config_opts, make_opts, install_opts);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_LIST:
            DB_list();
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_FETCH:
            check(url <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_fetch(p, url, <span style="color:#ae81ff">1</span>);
            log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Downloaded to %s and in /tmp/</span><span style="color:#e6db74">&#34;</span>, BUILD_DIR);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_BUILD:
            check(url, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You must at least give a URL.</span><span style="color:#e6db74">&#34;</span>);
            Command_build(p, url, config_opts, make_opts, install_opts);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">case</span> COMMAND_INIT:
            rv <span style="color:#f92672">=</span> DB_init();
            check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make the database.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;

        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid command given.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex41\devpkg\shell.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;shell.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdarg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_exec</span>(Shell template, ...)
{
    apr_pool_t <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    apr_status_t rv <span style="color:#f92672">=</span> APR_SUCCESS;
    va_list argp;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>arg <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rv <span style="color:#f92672">=</span> apr_pool_create(<span style="color:#f92672">&amp;</span>p, NULL);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create pool.</span><span style="color:#e6db74">&#34;</span>);

    va_start(argp, template);

    <span style="color:#66d9ef">for</span> (key <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);
            key <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; key <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)) {
        arg <span style="color:#f92672">=</span> va_arg(argp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>);

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; template.args[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">if</span> (strcmp(template.args[i], key) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
                template.args[i] <span style="color:#f92672">=</span> arg;
                <span style="color:#66d9ef">break</span>;        <span style="color:#75715e">// found it
</span><span style="color:#75715e"></span>            }
        }
    }

    rc <span style="color:#f92672">=</span> Shell_run(p, <span style="color:#f92672">&amp;</span>template);
    apr_pool_destroy(p);
    va_end(argp);
    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">if</span> (p) {
        apr_pool_destroy(p);
    }
    <span style="color:#66d9ef">return</span> rc;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_run</span>(apr_pool_t <span style="color:#f92672">*</span> p, Shell <span style="color:#f92672">*</span> cmd)
{
    apr_procattr_t <span style="color:#f92672">*</span>attr;
    apr_status_t rv;
    apr_proc_t newproc;

    rv <span style="color:#f92672">=</span> apr_procattr_create(<span style="color:#f92672">&amp;</span>attr, p);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create proc attr.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_procattr_io_set(attr, APR_NO_PIPE, APR_NO_PIPE,
            APR_NO_PIPE);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set IO of command.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_procattr_dir_set(attr, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>dir);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set root to %s</span><span style="color:#e6db74">&#34;</span>, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>dir);

    rv <span style="color:#f92672">=</span> apr_procattr_cmdtype_set(attr, APR_PROGRAM_PATH);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set cmd type.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_proc_create(<span style="color:#f92672">&amp;</span>newproc, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>args, NULL, attr, p);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_SUCCESS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run command.</span><span style="color:#e6db74">&#34;</span>);

    rv <span style="color:#f92672">=</span> apr_proc_wait(<span style="color:#f92672">&amp;</span>newproc, <span style="color:#f92672">&amp;</span>cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_code, <span style="color:#f92672">&amp;</span>cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_why,
            APR_WAIT);
    check(rv <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_CHILD_DONE, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to wait.</span><span style="color:#e6db74">&#34;</span>);

    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_code <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s exited badly.</span><span style="color:#e6db74">&#34;</span>, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe);
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exit_why <span style="color:#f92672">=</span><span style="color:#f92672">=</span> APR_PROC_EXIT, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s was killed or crashed</span><span style="color:#e6db74">&#34;</span>,
            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>exe);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

Shell CLEANUP_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rm</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rm</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-rf</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-src.tar.gz</span><span style="color:#e6db74">&#34;</span>,
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-src.tar.bz2</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/DEPENDS</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell GIT_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">git</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">clone</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pkg-build</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell TAR_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tar</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tar</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-xzf</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FILE</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">--strip-components</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell CURL_SH <span style="color:#f92672">=</span> {
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>,
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">curl</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">curl</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-L</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-o</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell CONFIGURE_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">./configure</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">configure</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, NULL}
    ,
};

Shell MAKE_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OPTS</span><span style="color:#e6db74">&#34;</span>, NULL}
};

Shell INSTALL_SH <span style="color:#f92672">=</span> {
    .exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sudo</span><span style="color:#e6db74">&#34;</span>,
    .dir <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/pkg-build</span><span style="color:#e6db74">&#34;</span>,
    .args <span style="color:#f92672">=</span> {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sudo</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">make</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TARGET</span><span style="color:#e6db74">&#34;</span>, NULL}
};

</code></pre></div><p>.\ex41\devpkg\shell.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _shell_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _shell_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define MAX_COMMAND_ARGS 100</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;apr_thread_proc.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Shell {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>dir;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>exe;

    apr_procattr_t <span style="color:#f92672">*</span>attr;
    apr_proc_t proc;
    apr_exit_why_e exit_why;
    <span style="color:#66d9ef">int</span> exit_code;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>args[MAX_COMMAND_ARGS];
} Shell;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_run</span>(apr_pool_t <span style="color:#f92672">*</span> p, Shell <span style="color:#f92672">*</span> cmd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Shell_exec</span>(Shell cmd, ...);

<span style="color:#66d9ef">extern</span> Shell CLEANUP_SH;
<span style="color:#66d9ef">extern</span> Shell GIT_SH;
<span style="color:#66d9ef">extern</span> Shell TAR_SH;
<span style="color:#66d9ef">extern</span> Shell CURL_SH;
<span style="color:#66d9ef">extern</span> Shell CONFIGURE_SH;
<span style="color:#66d9ef">extern</span> Shell MAKE_SH;
<span style="color:#66d9ef">extern</span> Shell INSTALL_SH;

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex41\ex41.1.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">set -e

<span style="color:#75715e">## go somewhere safe</span>
cd /tmp

<span style="color:#75715e">## get the source to base APR 1.5.2</span>
curl -L -O http://archive.apache.org/dist/apr/apr-1.5.2.tar.gz

<span style="color:#75715e">## extract it and go into the source</span>
tar -xzvf apr-1.5.2.tar.gz
cd apr-1.5.2

<span style="color:#75715e">## you need this on OSX Yosemite</span>
touch libtoolT

<span style="color:#75715e">## configure, make, make install</span>
./configure
make
sudo make install

<span style="color:#75715e">## reset and cleanup</span>
cd /tmp
rm -rf apr-1.5.2 apr-1.5.2.tar.gz

<span style="color:#75715e">## do the same with apr-util</span>
curl -L -O http://archive.apache.org/dist/apr/apr-util-1.5.4.tar.gz

<span style="color:#75715e">## extract</span>
tar -xzvf apr-util-1.5.4.tar.gz
cd apr-util-1.5.4

<span style="color:#75715e">## you need this on OSX Yosemite</span>
touch libtoolT

<span style="color:#75715e">## configure, make, make install</span>
./configure --with-apr<span style="color:#f92672">=</span>/usr/local/apr
<span style="color:#75715e">## you need that extra parameter to configure because</span>
<span style="color:#75715e">## apr-util can&#39;t really find it because...who knows.</span>

make
sudo make install

<span style="color:#75715e">#cleanup</span>
cd /tmp
rm -rf apr-util-1.5.4* apr-1.5.2*

</code></pre></div><p>.\ex41\ex41.2.sh</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir devpkg
cd devpkg
touch README Makefile

</code></pre></div><p>The Plan</p>
<p>Create a handy little tool called devpkg.</p>
<p>This will be a <em>lot</em> of work, so this video is more complete.</p>
<p>Demonstration</p>
<p>I'll demonstrate how devpkg works so you get a better idea.</p>
<p>Read the book's description as well for more details.</p>
<p>The Apache Portable Runtime</p>
<p>Review of the APR and installing it.</p>
<p>The Analysis</p>
<p>Walk through the code, where everything is, and what to watch out for.</p>
<p>Getting My Code</p>
<p>If you get stuck you can check out the learn-c-the-hard-way-lectures project:</p>
<p>And look in ex41/devpkg for the code.</p>
<p>Extra Credit</p>
<ul>
<li>Compare your code to my code available online.  Starting with 100%,
remove 1% for each line you got wrong.</li>
<li>Take the notes.txt file that you previously created and implement your improvements to the the code and functionality
of <code>devpkg</code>.</li>
<li>Write an alternative version of <code>devpkg</code> using your other
favorite language or the one you think can do this the best.  Compare
the two, then improve your <em>C</em> version of <code>devpkg</code> based on what
you've learned.</li>
</ul>
<h3 id="exercise-42-stacks-and-queues">Exercise 42 Stacks and Queues</h3>
<p>The Plan</p>
<p>Create a Stack and Queue data structure from just the unit tests.</p>
<p>PAUSE!</p>
<p>WARNING!  Stop the video now and try to solve this yourself!</p>
<p>I'll show you how I did it after you try it (or you can cheat).</p>
<p>Code Review</p>
<p>.\ex42\queue_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/queue.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> Queue <span style="color:#f92672">*</span>queue <span style="color:#f92672">=</span> NULL;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tests[] <span style="color:#f92672">=</span> { <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test1 data</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test2 data</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test3 data</span><span style="color:#e6db74">&#34;</span> };

<span style="color:#75715e">#</span><span style="color:#75715e">define NUM_TESTS 3</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    queue <span style="color:#f92672">=</span> Queue_create();
    mu_assert(queue <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create queue.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_destroy</span>()
{
    mu_assert(queue <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make queue #2</span><span style="color:#e6db74">&#34;</span>);
    Queue_destroy(queue);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_send_recv</span>()
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_TESTS; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        Queue_send(queue, tests[i]);
        mu_assert(Queue_peek(queue) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> tests[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong next value.</span><span style="color:#e6db74">&#34;</span>);
    }

    mu_assert(Queue_count(queue) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NUM_TESTS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong count on send.</span><span style="color:#e6db74">&#34;</span>);

    QUEUE_FOREACH(queue, cur) {
        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VAL: %s</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)cur<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value);
    }

    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_TESTS; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>val <span style="color:#f92672">=</span> Queue_recv(queue);
        mu_assert(val <span style="color:#f92672">=</span><span style="color:#f92672">=</span> tests[i], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong value on recv.</span><span style="color:#e6db74">&#34;</span>);
    }

    mu_assert(Queue_count(queue) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong count after recv.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_create);
    mu_run_test(test_send_recv);
    mu_run_test(test_destroy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex42\stack_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stack.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> Stack <span style="color:#f92672">*</span>stack <span style="color:#f92672">=</span> NULL;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tests[] <span style="color:#f92672">=</span> { <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test1 data</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test2 data</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">test3 data</span><span style="color:#e6db74">&#34;</span> };

<span style="color:#75715e">#</span><span style="color:#75715e">define NUM_TESTS 3</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    stack <span style="color:#f92672">=</span> Stack_create();
    mu_assert(stack <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create stack.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_destroy</span>()
{
    mu_assert(stack <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to make stack #2</span><span style="color:#e6db74">&#34;</span>);
    Stack_destroy(stack);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_push_pop</span>()
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_TESTS; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        Stack_push(stack, tests[i]);
        mu_assert(Stack_peek(stack) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> tests[i], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong next value.</span><span style="color:#e6db74">&#34;</span>);
    }

    mu_assert(Stack_count(stack) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NUM_TESTS, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong count on push.</span><span style="color:#e6db74">&#34;</span>);

    STACK_FOREACH(stack, cur) {
        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VAL: %s</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)cur<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value);
    }

    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> NUM_TESTS <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i<span style="color:#f92672">-</span><span style="color:#f92672">-</span>) {
        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>val <span style="color:#f92672">=</span> Stack_pop(stack);
        mu_assert(val <span style="color:#f92672">=</span><span style="color:#f92672">=</span> tests[i], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong value on pop.</span><span style="color:#e6db74">&#34;</span>);
    }

    mu_assert(Stack_count(stack) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Wrong count after pop.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_create);
    mu_run_test(test_push_pop);
    mu_run_test(test_destroy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Extra Credit</p>
<ul>
<li>Implement <code>Stack</code> using <code>DArray</code> instead of <code>List</code>, but without changing the unit test.  That means you'll have to create your own <code>STACK_FOREACH</code>.</li>
</ul>
<h3 id="exercise-43-a-simple-statistics-engine">Exercise 43 A Simple Statistics Engine</h3>
<p>.\ex43\stats.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef lcthw_stats_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define lcthw_stats_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Stats {
    <span style="color:#66d9ef">double</span> sum;
    <span style="color:#66d9ef">double</span> sumsq;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n;
    <span style="color:#66d9ef">double</span> min;
    <span style="color:#66d9ef">double</span> max;
} Stats;

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_recreate</span>(<span style="color:#66d9ef">double</span> sum, <span style="color:#66d9ef">double</span> sumsq, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n,
        <span style="color:#66d9ef">double</span> min, <span style="color:#66d9ef">double</span> max);

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_create</span>();

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_mean</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_stddev</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_sample</span>(Stats <span style="color:#f92672">*</span> st, <span style="color:#66d9ef">double</span> s);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_dump</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex43\stats.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_recreate</span>(<span style="color:#66d9ef">double</span> sum, <span style="color:#66d9ef">double</span> sumsq, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n,
        <span style="color:#66d9ef">double</span> min, <span style="color:#66d9ef">double</span> max)
{
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(Stats));
    check_mem(st);

    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">=</span> sum;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">=</span> sumsq;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span> n;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> min;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> max;

    <span style="color:#66d9ef">return</span> st;

error:
    <span style="color:#66d9ef">return</span> NULL;
}

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_create</span>()
{
    <span style="color:#66d9ef">return</span> Stats_recreate(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0L</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>);
}

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_mean</span>(Stats <span style="color:#f92672">*</span> st)
{
    <span style="color:#66d9ef">return</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">/</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n;
}

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_stddev</span>(Stats <span style="color:#f92672">*</span> st)
{
    <span style="color:#66d9ef">return</span> sqrt((st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">-</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">*</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">/</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n)) <span style="color:#f92672">/</span>
            (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>));
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_sample</span>(Stats <span style="color:#f92672">*</span> st, <span style="color:#66d9ef">double</span> s)
{
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> s;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">+</span><span style="color:#f92672">=</span> s <span style="color:#f92672">*</span> s;

    <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> s;
        st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> s;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">&gt;</span> s)
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> s;
        <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">&lt;</span> s)
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> s;
    }

    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_dump</span>(Stats <span style="color:#f92672">*</span> st)
{
    fprintf(stderr,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum: %f, sumsq: %f, n: %ld, </span><span style="color:#e6db74">&#34;</span>
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min: %f, max: %f, mean: %f, stddev: %f</span><span style="color:#e6db74">&#34;</span>,
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max, Stats_mean(st),
            Stats_stddev(st));
}

</code></pre></div><p>.\ex43\stats_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> NUM_SAMPLES <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
<span style="color:#66d9ef">double</span> samples[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">6.1061334</span>, <span style="color:#ae81ff">9.6783204</span>, <span style="color:#ae81ff">1.2747090</span>, <span style="color:#ae81ff">8.2395131</span>, <span style="color:#ae81ff">0.3333483</span>,
    <span style="color:#ae81ff">6.9755066</span>, <span style="color:#ae81ff">1.0626275</span>, <span style="color:#ae81ff">7.6587523</span>, <span style="color:#ae81ff">4.9382973</span>, <span style="color:#ae81ff">9.5788115</span>
};

Stats expect <span style="color:#f92672">=</span> {
    .sumsq <span style="color:#f92672">=</span> <span style="color:#ae81ff">425.1641</span>,
    .sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">55.84602</span>,
    .min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.333</span>,
    .max <span style="color:#f92672">=</span> <span style="color:#ae81ff">9.678</span>,
    .n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
};

<span style="color:#66d9ef">double</span> expect_mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">5.584602</span>;
<span style="color:#66d9ef">double</span> expect_stddev <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.547868</span>;

<span style="color:#75715e">#</span><span style="color:#75715e">define EQ(X,Y,N) (round((X) * pow(10, N)) == round((Y) * pow(10, N)))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_operations</span>()
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> Stats_create();
    mu_assert(st <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create stats.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_SAMPLES; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        Stats_sample(st, samples[i]);
    }

    Stats_dump(st);

    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq, expect.sumsq, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sumsq not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum, expect.sum, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min, expect.min, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max, expect.max, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n, expect.n, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_mean, Stats_mean(st), <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_stddev, Stats_stddev(st), <span style="color:#ae81ff">3</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev not valid</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_recreate</span>()
{
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> Stats_recreate(
            expect.sum, expect.sumsq, expect.n, expect.min, expect.max);

    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.sum, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.sumsq, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sumsq not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.n, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">n not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.min, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.max, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_mean, Stats_mean(st), <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_stddev, Stats_stddev(st), <span style="color:#ae81ff">3</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev not valid</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_operations);
    mu_run_test(test_recreate);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex43\stats.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef lcthw_stats_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define lcthw_stats_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Stats {
    <span style="color:#66d9ef">double</span> sum;
    <span style="color:#66d9ef">double</span> sumsq;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n;
    <span style="color:#66d9ef">double</span> min;
    <span style="color:#66d9ef">double</span> max;
} Stats;

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_recreate</span>(<span style="color:#66d9ef">double</span> sum, <span style="color:#66d9ef">double</span> sumsq, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n,
        <span style="color:#66d9ef">double</span> min, <span style="color:#66d9ef">double</span> max);

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_create</span>();

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_mean</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_stddev</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_sample</span>(Stats <span style="color:#f92672">*</span> st, <span style="color:#66d9ef">double</span> s);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_dump</span>(Stats <span style="color:#f92672">*</span> st);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex43\stats.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_recreate</span>(<span style="color:#66d9ef">double</span> sum, <span style="color:#66d9ef">double</span> sumsq, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n,
        <span style="color:#66d9ef">double</span> min, <span style="color:#66d9ef">double</span> max)
{
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(Stats));
    check_mem(st);

    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">=</span> sum;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">=</span> sumsq;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span> n;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> min;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> max;

    <span style="color:#66d9ef">return</span> st;

error:
    <span style="color:#66d9ef">return</span> NULL;
}

Stats <span style="color:#f92672">*</span><span style="color:#a6e22e">Stats_create</span>()
{
    <span style="color:#66d9ef">return</span> Stats_recreate(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0L</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>);
}

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_mean</span>(Stats <span style="color:#f92672">*</span> st)
{
    <span style="color:#66d9ef">return</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">/</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n;
}

<span style="color:#66d9ef">double</span> <span style="color:#a6e22e">Stats_stddev</span>(Stats <span style="color:#f92672">*</span> st)
{
    <span style="color:#66d9ef">return</span> sqrt((st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">-</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">*</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">/</span> st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n)) <span style="color:#f92672">/</span>
            (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>));
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_sample</span>(Stats <span style="color:#f92672">*</span> st, <span style="color:#66d9ef">double</span> s)
{
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> s;
    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">+</span><span style="color:#f92672">=</span> s <span style="color:#f92672">*</span> s;

    <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> s;
        st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> s;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">&gt;</span> s)
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span> s;
        <span style="color:#66d9ef">if</span> (st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">&lt;</span> s)
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span> s;
    }

    st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Stats_dump</span>(Stats <span style="color:#f92672">*</span> st)
{
    fprintf(stderr,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum: %f, sumsq: %f, n: %ld, </span><span style="color:#e6db74">&#34;</span>
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min: %f, max: %f, mean: %f, stddev: %f</span><span style="color:#e6db74">&#34;</span>,
            st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min, st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max, Stats_mean(st),
            Stats_stddev(st));
}

</code></pre></div><p>.\ex43\stats_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> NUM_SAMPLES <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
<span style="color:#66d9ef">double</span> samples[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">6.1061334</span>, <span style="color:#ae81ff">9.6783204</span>, <span style="color:#ae81ff">1.2747090</span>, <span style="color:#ae81ff">8.2395131</span>, <span style="color:#ae81ff">0.3333483</span>,
    <span style="color:#ae81ff">6.9755066</span>, <span style="color:#ae81ff">1.0626275</span>, <span style="color:#ae81ff">7.6587523</span>, <span style="color:#ae81ff">4.9382973</span>, <span style="color:#ae81ff">9.5788115</span>
};

Stats expect <span style="color:#f92672">=</span> {
    .sumsq <span style="color:#f92672">=</span> <span style="color:#ae81ff">425.1641</span>,
    .sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">55.84602</span>,
    .min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.333</span>,
    .max <span style="color:#f92672">=</span> <span style="color:#ae81ff">9.678</span>,
    .n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
};

<span style="color:#66d9ef">double</span> expect_mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">5.584602</span>;
<span style="color:#66d9ef">double</span> expect_stddev <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.547868</span>;

<span style="color:#75715e">#</span><span style="color:#75715e">define EQ(X,Y,N) (round((X) * pow(10, N)) == round((Y) * pow(10, N)))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_operations</span>()
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> Stats_create();
    mu_assert(st <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to create stats.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NUM_SAMPLES; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        Stats_sample(st, samples[i]);
    }

    Stats_dump(st);

    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq, expect.sumsq, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sumsq not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum, expect.sum, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min, expect.min, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max, expect.max, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n, expect.n, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_mean, Stats_mean(st), <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_stddev, Stats_stddev(st), <span style="color:#ae81ff">3</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev not valid</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_recreate</span>()
{
    Stats <span style="color:#f92672">*</span>st <span style="color:#f92672">=</span> Stats_recreate(
            expect.sum, expect.sumsq, expect.n, expect.min, expect.max);

    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.sum, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sum not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.sumsq, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sumsq not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.n, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">n not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.min, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">min not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(st<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expect.max, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">max not equal</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_mean, Stats_mean(st), <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean not valid</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(EQ(expect_stddev, Stats_stddev(st), <span style="color:#ae81ff">3</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev not valid</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_operations);
    mu_run_test(test_recreate);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>The Plan</p>
<ul>
<li>A fun and handy little statistics engine for simple analysis.</li>
<li>Comparing it to the same in R.</li>
</ul>
<p>Comparing Test vs. R</p>
<p>I'll use R to show you how this works vs. normal calculations using all data.</p>
<p>Breaking It</p>
<p>Easiest way to break this is to just feed it bad data once then the whole
stream is broken.</p>
<p>Extra Credit</p>
<ul>
<li>Convert the <code>Stats_stddev</code> and <code>Stats_mean</code> to <code>static inline</code> functions in the <code>stats.h</code> file instead of in the <code>stats.c</code> file.</li>
<li>Use this code to write a performance test of the <code>string_algos_test.c</code>.
Make it optional, and have it run the base test as a series of samples, and then report
the results.</li>
<li>Write a version of this in another programming language you know.  Confirm that this
version is correct based on what I have here.</li>
</ul>
<p>Extra Credit</p>
<ul>
<li>Write a little program that can take a file full of numbers and spit these statistics
out for them.</li>
<li>Make the program accept a table of data that has headers on one line, then all
of the other numbers on lines after it are separated by any number of spaces.  Your program
should then print out these statistics for each column by the header name.</li>
</ul>
<h3 id="exercise-44-ring-buffer">Exercise 44 Ring Buffer</h3>
<p>The Plan</p>
<p>Learn about a handy data structure for I/O processing:</p>
<p>Ring Buffers</p>
<p>The Code</p>
<p>.\ex44\netclient.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">undef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    fd_set allreads;
    fd_set readmask;

    <span style="color:#66d9ef">int</span> socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>in_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>);
    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>);

    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: netclient host port</span><span style="color:#e6db74">&#34;</span>);

    socket <span style="color:#f92672">=</span> client_connect(argv[<span style="color:#ae81ff">1</span>], argv[<span style="color:#ae81ff">2</span>]);
    check(socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">connect to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>], argv[<span style="color:#ae81ff">2</span>]);

    FD_ZERO(<span style="color:#f92672">&amp;</span>allreads);
    FD_SET(socket, <span style="color:#f92672">&amp;</span>allreads);
    FD_SET(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>allreads);

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        readmask <span style="color:#f92672">=</span> allreads;
        rc <span style="color:#f92672">=</span> select(socket <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>readmask, NULL, NULL, NULL);
        check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">select failed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#66d9ef">if</span> (FD_ISSET(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>readmask)) {
            rc <span style="color:#f92672">=</span> read_some(in_rb, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from stdin.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">if</span> (FD_ISSET(socket, <span style="color:#f92672">&amp;</span>readmask)) {
            rc <span style="color:#f92672">=</span> read_some(sock_rb, socket, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from socket.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>RingBuffer_empty(sock_rb)) {
            rc <span style="color:#f92672">=</span> write_some(sock_rb, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write to stdout.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>RingBuffer_empty(in_rb)) {
            rc <span style="color:#f92672">=</span> write_some(in_rb, socket, <span style="color:#ae81ff">1</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write to socket.</span><span style="color:#e6db74">&#34;</span>);
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>It's basically a DArray with dynamic start and end settings.
You can <em>also</em> use a Queue of bstrings to do almost the same thing.</p>
<p>Code Review</p>
<p>.\ex44\netclient.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">undef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    fd_set allreads;
    fd_set readmask;

    <span style="color:#66d9ef">int</span> socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>in_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>);
    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>);

    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: netclient host port</span><span style="color:#e6db74">&#34;</span>);

    socket <span style="color:#f92672">=</span> client_connect(argv[<span style="color:#ae81ff">1</span>], argv[<span style="color:#ae81ff">2</span>]);
    check(socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">connect to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">1</span>], argv[<span style="color:#ae81ff">2</span>]);

    FD_ZERO(<span style="color:#f92672">&amp;</span>allreads);
    FD_SET(socket, <span style="color:#f92672">&amp;</span>allreads);
    FD_SET(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>allreads);

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        readmask <span style="color:#f92672">=</span> allreads;
        rc <span style="color:#f92672">=</span> select(socket <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>readmask, NULL, NULL, NULL);
        check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">select failed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#66d9ef">if</span> (FD_ISSET(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>readmask)) {
            rc <span style="color:#f92672">=</span> read_some(in_rb, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from stdin.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">if</span> (FD_ISSET(socket, <span style="color:#f92672">&amp;</span>readmask)) {
            rc <span style="color:#f92672">=</span> read_some(sock_rb, socket, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from socket.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>RingBuffer_empty(sock_rb)) {
            rc <span style="color:#f92672">=</span> write_some(sock_rb, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write to stdout.</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>RingBuffer_empty(in_rb)) {
            rc <span style="color:#f92672">=</span> write_some(in_rb, socket, <span style="color:#ae81ff">1</span>);
            check_debug(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write to socket.</span><span style="color:#e6db74">&#34;</span>);
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>The Analysis</p>
<ul>
<li>Watch a ring buffer work in the debugger.</li>
<li>Draw it visually to explore it.</li>
<li>The purpose is to efficiently add and remove data when the amount added and removed is random.</li>
</ul>
<p>Pause!</p>
<p>I will next review the unit test I wrote so if you want to attempt
solving it yourself then pause now.</p>
<p>The Unit Test</p>
<p>Here's my version of the unit test.</p>
<p>Breaking It</p>
<ul>
<li>The biggest mistake you'll make with a ring buffer is off-by-one errors.</li>
<li>This is why the RingBuffer_commit_ and other macros exist.</li>
<li>Another common mistake is to use it between threads, but that's a whole other book.</li>
</ul>
<p>Extra Credit</p>
<ul>
<li>Create an alternative implementation of <code>RingBuffer</code> that uses
the POSIX trick and a unit test for it.</li>
<li>Add a performance comparison test to this unit test that compares the
two versions by fuzzing them with random data and random read/write operations.
Make sure that you set up this fuzzing so that the same operations are done
to each version, and you can compare them between runs.</li>
</ul>
<h3 id="exercise-45-a-simple-tcpip-client">Exercise 45 A Simple TCP/IP Client</h3>
<p>The Plan</p>
<ul>
<li>Learn to use the <em>select</em> method and a RingBuffer to write a simple command line network client.</li>
</ul>
<p>How select Works</p>
<p>Code Review</p>
<p>Improving It</p>
<p>These read functions are useful so I can put them in RingBuffer.</p>
<p>Extra Credit</p>
<ul>
<li>As I mentioned, there are quite a few functions you may not know, so
look them up.  In fact, look them all up even if you think you know
them.</li>
<li>Go back through and add various defensive programming checks to
the functions to improve them.</li>
<li>Use the <em>getopt</em> function to allow the user
the option <em>not</em> to translate <em>\n</em> to <em>\r\n</em>. This
is only needed on protocols that require it for line endings, like HTTP.
Sometimes you don't want the translation, so give the user the option.</li>
</ul>
<h3 id="exercise-46-ternary-search-tree">Exercise 46 Ternary Search Tree</h3>
<p>The Plan</p>
<p>Learn about my favorite data structure ever:</p>
<p>Ternary Search Tree</p>
<p>The Code</p>
<p>.\ex46\tstree.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _lcthw_TSTree_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _lcthw_TSTree_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/darray.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> TSTree {
    <span style="color:#66d9ef">char</span> splitchar;
    <span style="color:#66d9ef">struct</span> TSTree <span style="color:#f92672">*</span>low;
    <span style="color:#66d9ef">struct</span> TSTree <span style="color:#f92672">*</span>equal;
    <span style="color:#66d9ef">struct</span> TSTree <span style="color:#f92672">*</span>high;
    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value;
} TSTree;

<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_search</span>(TSTree <span style="color:#f92672">*</span> root, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len);

<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_search_prefix</span>(TSTree <span style="color:#f92672">*</span> root, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len);

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">void</span> (<span style="color:#f92672">*</span>TSTree_traverse_cb) (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data);

TSTree <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_insert</span>(TSTree <span style="color:#f92672">*</span> node, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len,
        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TSTree_traverse</span>(TSTree <span style="color:#f92672">*</span> node, TSTree_traverse_cb cb, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TSTree_destroy</span>(TSTree <span style="color:#f92672">*</span> root);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex46\tstree.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/tstree.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> TSTree <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_insert_base</span>(TSTree <span style="color:#f92672">*</span> root, TSTree <span style="color:#f92672">*</span> node,
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len,
        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value)
{
    <span style="color:#66d9ef">if</span> (node <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        node <span style="color:#f92672">=</span> (TSTree <span style="color:#f92672">*</span>) calloc(<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(TSTree));

        <span style="color:#66d9ef">if</span> (root <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
            root <span style="color:#f92672">=</span> node;
        }

        node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>key;
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>key <span style="color:#f92672">&lt;</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
        node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low <span style="color:#f92672">=</span> TSTree_insert_base(
                root, node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low, key, len, value);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>key <span style="color:#f92672">=</span><span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
        <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) {
            node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal <span style="color:#f92672">=</span> TSTree_insert_base(
                    root, node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal, key <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, len <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, value);
        } <span style="color:#66d9ef">else</span> {
            assert(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Duplicate insert into tst.</span><span style="color:#e6db74">&#34;</span>);
            node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value <span style="color:#f92672">=</span> value;
        }
    } <span style="color:#66d9ef">else</span> {
        node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high <span style="color:#f92672">=</span> TSTree_insert_base(
                root, node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high, key, len, value);
    }

    <span style="color:#66d9ef">return</span> node;
}

TSTree <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_insert</span>(TSTree <span style="color:#f92672">*</span> node, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len,
        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value)
{
    <span style="color:#66d9ef">return</span> TSTree_insert_base(node, node, key, len, value);
}

<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_search</span>(TSTree <span style="color:#f92672">*</span> root, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len)
{
    TSTree <span style="color:#f92672">*</span>node <span style="color:#f92672">=</span> root;
    size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> node) {
        <span style="color:#66d9ef">if</span> (key[i] <span style="color:#f92672">&lt;</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
            node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (key[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
            i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> len)
                node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal;
        } <span style="color:#66d9ef">else</span> {
            node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high;
        }
    }

    <span style="color:#66d9ef">if</span> (node) {
        <span style="color:#66d9ef">return</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">return</span> NULL;
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TSTree_search_prefix</span>(TSTree <span style="color:#f92672">*</span> root, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key, size_t len)
{
    <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">return</span> NULL;

    TSTree <span style="color:#f92672">*</span>node <span style="color:#f92672">=</span> root;
    TSTree <span style="color:#f92672">*</span>last <span style="color:#f92672">=</span> NULL;
    size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> node) {
        <span style="color:#66d9ef">if</span> (key[i] <span style="color:#f92672">&lt;</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
            node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low;
        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (key[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>splitchar) {
            i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> len) {
                <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value)
                    last <span style="color:#f92672">=</span> node;
                node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal;
            }
        } <span style="color:#66d9ef">else</span> {
            node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high;
        }
    }

    node <span style="color:#f92672">=</span> node <span style="color:#f92672">?</span> node : last;

    <span style="color:#75715e">// traverse until we find the first value in the equal chain
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// this is then the first node with this prefix
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (node <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#f92672">!</span>node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value) {
        node <span style="color:#f92672">=</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal;
    }

    <span style="color:#66d9ef">return</span> node <span style="color:#f92672">?</span> node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value : NULL;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TSTree_traverse</span>(TSTree <span style="color:#f92672">*</span> node, TSTree_traverse_cb cb, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data)
{
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>node)
        <span style="color:#66d9ef">return</span>;

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low)
        TSTree_traverse(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low, cb, data);

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal) {
        TSTree_traverse(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal, cb, data);
    }

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high)
        TSTree_traverse(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high, cb, data);

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value)
        cb(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>value, data);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TSTree_destroy</span>(TSTree <span style="color:#f92672">*</span> node)
{
    <span style="color:#66d9ef">if</span> (node <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL)
        <span style="color:#66d9ef">return</span>;

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low)
        TSTree_destroy(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>low);

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal) {
        TSTree_destroy(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>equal);
    }

    <span style="color:#66d9ef">if</span> (node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high)
        TSTree_destroy(node<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>high);

    free(node);
}

</code></pre></div><p>.\ex46\tstree_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/tstree.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
TSTree <span style="color:#f92672">*</span>node <span style="color:#f92672">=</span> NULL;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>valueA <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VALUEA</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>valueB <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VALUEB</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>value2 <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VALUE2</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>value4 <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VALUE4</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>reverse <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VALUER</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">int</span> traverse_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">struct</span> tagbstring test1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TEST</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring test2 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TEST2</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring test3 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TSET</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring test4 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">T</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_insert</span>()
{
    node <span style="color:#f92672">=</span> TSTree_insert(node, bdata(<span style="color:#f92672">&amp;</span>test1), blength(<span style="color:#f92672">&amp;</span>test1), valueA);
    mu_assert(node <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to insert into tst.</span><span style="color:#e6db74">&#34;</span>);

    node <span style="color:#f92672">=</span> TSTree_insert(node, bdata(<span style="color:#f92672">&amp;</span>test2), blength(<span style="color:#f92672">&amp;</span>test2), value2);
    mu_assert(node <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to insert into tst with second name.</span><span style="color:#e6db74">&#34;</span>);

    node <span style="color:#f92672">=</span> TSTree_insert(node, bdata(<span style="color:#f92672">&amp;</span>test3), blength(<span style="color:#f92672">&amp;</span>test3), reverse);
    mu_assert(node <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to insert into tst with reverse name.</span><span style="color:#e6db74">&#34;</span>);

    node <span style="color:#f92672">=</span> TSTree_insert(node, bdata(<span style="color:#f92672">&amp;</span>test4), blength(<span style="color:#f92672">&amp;</span>test4), value4);
    mu_assert(node <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to insert into tst with second name.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_search_exact</span>()
{
    <span style="color:#75715e">// tst returns the last one inserted
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>res <span style="color:#f92672">=</span> TSTree_search(node, bdata(<span style="color:#f92672">&amp;</span>test1), blength(<span style="color:#f92672">&amp;</span>test1));
    mu_assert(res <span style="color:#f92672">=</span><span style="color:#f92672">=</span> valueA,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got the wrong value back, should get A not B.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// tst does not find if not exact
</span><span style="color:#75715e"></span>    res <span style="color:#f92672">=</span> TSTree_search(node, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TESTNO</span><span style="color:#e6db74">&#34;</span>, strlen(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TESTNO</span><span style="color:#e6db74">&#34;</span>));
    mu_assert(res <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Should not find anything.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_search_prefix</span>()
{
    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>res <span style="color:#f92672">=</span> TSTree_search_prefix(
            node, bdata(<span style="color:#f92672">&amp;</span>test1), blength(<span style="color:#f92672">&amp;</span>test1));
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">result: %p, expected: %p</span><span style="color:#e6db74">&#34;</span>, res, valueA);
    mu_assert(res <span style="color:#f92672">=</span><span style="color:#f92672">=</span> valueA, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got wrong valueA by prefix.</span><span style="color:#e6db74">&#34;</span>);

    res <span style="color:#f92672">=</span> TSTree_search_prefix(node, bdata(<span style="color:#f92672">&amp;</span>test1), <span style="color:#ae81ff">1</span>);
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">result: %p, expected: %p</span><span style="color:#e6db74">&#34;</span>, res, valueA);
    mu_assert(res <span style="color:#f92672">=</span><span style="color:#f92672">=</span> value4, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got wrong value4 for prefix of 1.</span><span style="color:#e6db74">&#34;</span>);

    res <span style="color:#f92672">=</span> TSTree_search_prefix(node, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TE</span><span style="color:#e6db74">&#34;</span>, strlen(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TE</span><span style="color:#e6db74">&#34;</span>));
    mu_assert(res <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Should find for short prefix.</span><span style="color:#e6db74">&#34;</span>);

    res <span style="color:#f92672">=</span> TSTree_search_prefix(node, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TE--</span><span style="color:#e6db74">&#34;</span>, strlen(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TE--</span><span style="color:#e6db74">&#34;</span>));
    mu_assert(res <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Should find for partial prefix.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TSTree_traverse_test_cb</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data)
{
    assert(value <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Should not get NULL value.</span><span style="color:#e6db74">&#34;</span>);
    assert(data <span style="color:#f92672">=</span><span style="color:#f92672">=</span> valueA <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Expecting valueA as the data.</span><span style="color:#e6db74">&#34;</span>);
    traverse_count<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_traverse</span>()
{
    traverse_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    TSTree_traverse(node, TSTree_traverse_test_cb, valueA);
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traverse count is: %d</span><span style="color:#e6db74">&#34;</span>, traverse_count);
    mu_assert(traverse_count <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Didn&#39;t find 4 keys.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_destroy</span>()
{
    TSTree_destroy(node);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_insert);
    mu_run_test(test_search_exact);
    mu_run_test(test_search_prefix);
    mu_run_test(test_traverse);
    mu_run_test(test_destroy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Similar to a Binary Search Tree, but it has 3 branches per node based on
the characters in strings.</p>
<p>Advantages</p>
<ul>
<li>Find any string comparing at most N characters.</li>
<li>Detect <em>missing</em> strings as fast, usually faster.</li>
<li>Find all strings that start with, or contain, any substring as fast.</li>
<li>Find all similar known strings quickly.</li>
</ul>
<p>Disadvantages</p>
<ul>
<li>Delete is a pain, as in most trees.</li>
<li>Uses lots of memory to store keys, so bad for sets of large keys.</li>
<li>Kind of weird for most programmers.</li>
</ul>
<p>Improving It</p>
<ul>
<li>You could allow duplicates by using a <em>DArray</em> instead of the
<em>value</em>.</li>
<li>As I mentioned earlier, deleting is hard, but you could simulate it by setting
the values to <em>NULL</em> so that they are effectively gone.</li>
<li>There are no ways to collect all of the possible matching values.  I'll have
you implement that in an extra credit.</li>
<li>There are other algorithms that are more complex but have slightly
better properties.  Take a look at suffix array, suffix tree, and
radix tree structures.</li>
</ul>
<p>Extra Credit</p>
<ul>
<li>Implement a <em>TSTree_collect</em> that returns a <em>DArray</em> containing
all of the keys that match the given prefix.</li>
<li>Implement <em>TSTree_search_suffix</em> and a <em>TSTree_insert_suffix</em>
so you can do suffix searches and inserts.</li>
<li>Use the debugger to see how this structure is used in memory
compared to the <em>BSTree</em> and <em>Hashmap</em>.</li>
</ul>
<h3 id="exercise-47-a-fast-url-router">Exercise 47 A Fast URL Router</h3>
<p>The Plan</p>
<p>Use the <em>TSTree</em> to do something useful:</p>
<p>Route URLs</p>
<p>.\ex47\ex47_urls.txt</p>
<pre><code>/test.tst TestHandler
/ IndexHandler
/test/this/out/index.html PageHandler
/index.html PageHandler
/and/then/i/have/things/to/test.html PageHandler

</code></pre><p>Code Review</p>
<p>.\ex47\urlor.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/tstree.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
TSTree <span style="color:#f92672">*</span><span style="color:#a6e22e">add_route_data</span>(TSTree <span style="color:#f92672">*</span> routes, bstring line)
{
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>data <span style="color:#f92672">=</span> bsplit(line, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#39;</span>);
    check(data<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Line &#39;%s&#39; does not have 2 columns</span><span style="color:#e6db74">&#34;</span>,
            bdata(line));

    routes <span style="color:#f92672">=</span> TSTree_insert(routes,
            bdata(data<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>]),
            blength(data<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>]),
            bstrcpy(data<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>]));

    bstrListDestroy(data);

    <span style="color:#66d9ef">return</span> routes;

error:
    <span style="color:#66d9ef">return</span> NULL;
}

TSTree <span style="color:#f92672">*</span><span style="color:#a6e22e">load_routes</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file)
{
    TSTree <span style="color:#f92672">*</span>routes <span style="color:#f92672">=</span> NULL;
    bstring line <span style="color:#f92672">=</span> NULL;
    FILE <span style="color:#f92672">*</span>routes_map <span style="color:#f92672">=</span> NULL;

    routes_map <span style="color:#f92672">=</span> fopen(file, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>);
    check(routes_map <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open routes: %s</span><span style="color:#e6db74">&#34;</span>, file);

    <span style="color:#66d9ef">while</span> ((line <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, routes_map, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL) {
        check(btrimws(line) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to trim line.</span><span style="color:#e6db74">&#34;</span>);
        routes <span style="color:#f92672">=</span> add_route_data(routes, line);
        check(routes <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add route.</span><span style="color:#e6db74">&#34;</span>);
        bdestroy(line);
    }

    fclose(routes_map);
    <span style="color:#66d9ef">return</span> routes;

error:
    <span style="color:#66d9ef">if</span> (routes_map) fclose(routes_map);
    <span style="color:#66d9ef">if</span> (line) bdestroy(line);

    <span style="color:#66d9ef">return</span> NULL;
}

bstring <span style="color:#a6e22e">match_url</span>(TSTree <span style="color:#f92672">*</span> routes, bstring url)
{
    bstring route <span style="color:#f92672">=</span> TSTree_search(routes, bdata(url), blength(url));

    <span style="color:#66d9ef">if</span> (route <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">No exact match found, trying prefix.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        route <span style="color:#f92672">=</span> TSTree_search_prefix(routes, bdata(url), blength(url));
    }

    <span style="color:#66d9ef">return</span> route;
}

bstring <span style="color:#a6e22e">read_line</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prompt)
{
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>, prompt);

    bstring result <span style="color:#f92672">=</span> bgets((bNgetc) fgetc, stdin, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>);
    check_debug(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stdin closed.</span><span style="color:#e6db74">&#34;</span>);

    check(btrimws(result) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to trim.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> result;

error:
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bdestroy_cb</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>value, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ignored)
{
    (<span style="color:#66d9ef">void</span>)ignored;
    bdestroy((bstring) value);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">destroy_routes</span>(TSTree <span style="color:#f92672">*</span> routes)
{
    TSTree_traverse(routes, bdestroy_cb, NULL);
    TSTree_destroy(routes);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    bstring url <span style="color:#f92672">=</span> NULL;
    bstring route <span style="color:#f92672">=</span> NULL;
    TSTree <span style="color:#f92672">*</span>routes <span style="color:#f92672">=</span> NULL;

    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: urlor &lt;urlfile&gt;</span><span style="color:#e6db74">&#34;</span>);

    routes <span style="color:#f92672">=</span> load_routes(argv[<span style="color:#ae81ff">1</span>]);
    check(routes <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Your route file has an error.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        url <span style="color:#f92672">=</span> read_line(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">URL&gt; </span><span style="color:#e6db74">&#34;</span>);
        check_debug(url <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">goodbye.</span><span style="color:#e6db74">&#34;</span>);

        route <span style="color:#f92672">=</span> match_url(routes, url);

        <span style="color:#66d9ef">if</span> (route) {
            printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">MATCH: %s == %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, bdata(url), bdata(route));
        } <span style="color:#66d9ef">else</span> {
            printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FAIL: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, bdata(url));
        }

        bdestroy(url);
    }

    destroy_routes(routes);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:
    destroy_routes(routes);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>The Analysis</p>
<p>Watch me play with it and then tell you how it's working.</p>
<p>Improving It</p>
<ul>
<li>Collect all possible matches then choose the longest as winner.</li>
<li>Use TSTree to find prefixes, then regex to choose winner.</li>
</ul>
<p>Extra Credit</p>
<ul>
<li>Instead of just storing the string for the handler, create an actual engine that uses a
<em>Handler</em> struct to store the application.  The structure would store the URL to which it's attached, the name, and anything else you'd need to make an actual routing system.</li>
</ul>
<p>Extra Credit</p>
<ul>
<li>Instead of mapping URLs to arbitrary names, map them to .so files and use the <em>dlopen</em>
system to load handlers on the fly and call callbacks they contain.  Put these callbacks that
in your <em>Handler</em> struct, and then you have yourself a fully dynamic callback
handler system in C.</li>
</ul>
<h3 id="exercise-48a-a-simple-network-server">Exercise 48a A Simple Network Server:</h3>
<p>Project Description</p>
<p>The Plan</p>
<p>Start your first long running project:</p>
<p>statserve</p>
<p>The Purpose</p>
<p>You'll get the project started and get a minimum first hack going.</p>
<p>The Requirements</p>
<ol>
<li>Create a simple network server that accepts a connection on port 7899 from
<em>netclient</em> or the <em>nc</em> command, and echoes back anything you type.</li>
<li>You'll need to learn how to bind a port, listen on the socket, and answer it.
Use your research skills to study how this is done and attempt to implement it
yourself.</li>
</ol>
<p>The Requirements</p>
<ol start="3">
<li>The more important part of this project is laying out the project directory
from the <em>c-skeleton</em>, and making sure you can build everything and get it
working.</li>
<li>Don't worry about things like daemons or anything else.  Your server just has
to run from the command line and keep running.</li>
</ol>
<p>The Clues</p>
<p>I will now give you some clues:</p>
<ul>
<li>USE liblcthw!</li>
<li>Remember you did a client already, you just need to make a server.</li>
<li>Do NOT use select! Use fork() for the server.</li>
<li>Keep it <em>simple</em>.  Don't worry about anything other than accepting a connection and closing.</li>
<li>Stay small, build slowly.</li>
</ul>
<p>Important References</p>
<ul>
<li>Research online for &ldquo;echo server in C&rdquo;.</li>
<li>Read man (2) pages for <em>accept</em>, <em>bind</em>, <em>listen</em>, <em>connect</em>, <em>select</em>, <em>socket</em>, and <em>shutdown</em>.</li>
</ul>
<p>Encouragement</p>
<p>This will be <em>HARD</em>!  Try it your best, and take it piece by piece.  You can do it, but remember if you give up the next video (48b) will show you the code to my solution and how to solve it.  You can peek there then come back when you're stuck.</p>
<h3 id="exercise-48b-a-simple-network-server">Exercise 48b A Simple Network Server:</h3>
<p>.\ex48b\c-skeleton</p>
<p>.\ex48b\c-skeleton\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\c-skeleton\src\libex29.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_a_message</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A STRING: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">uppercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, toupper(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">lowercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, tolower(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fail_on_purpose</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
} 

</code></pre></div><p>.\ex48b\c-skeleton\tests\libex29_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>lib_function) (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data);
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>lib_file <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">build/libYOUR_LIBRARY.so</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>lib <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_function</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>func_to_run, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data,
        <span style="color:#66d9ef">int</span> expected)
{
    lib_function func <span style="color:#f92672">=</span> dlsym(lib, func_to_run);
    check(func <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Did not find %s function in the library %s: %s</span><span style="color:#e6db74">&#34;</span>, func_to_run,
            lib_file, dlerror());

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> func(data);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expected, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Function %s return %d for data: %s</span><span style="color:#e6db74">&#34;</span>,
            func_to_run, rc, data);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlopen</span>()
{
    lib <span style="color:#f92672">=</span> dlopen(lib_file, RTLD_NOW);
    mu_assert(lib <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open the library to test.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_functions</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_failures</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose should fail.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlclose</span>()
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> dlclose(lib);
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close lib.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dlopen);
    mu_run_test(test_functions);
    mu_run_test(test_failures);
    mu_run_test(test_dlclose);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\statserve</p>
<p>.\ex48b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

</code></pre></div><p>.\ex48b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// need a ringbuffer for the input
</span><span style="color:#75715e"></span>    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    <span style="color:#75715e">// read_some in a loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// write_it back off the ringbuffer
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(write_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
            debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sock_rb) RingBuffer_destroy(sock_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dummy</span>()
{
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dummy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\c-skeleton</p>
<p>.\ex48b\c-skeleton\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\c-skeleton\src\libex29.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_a_message</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A STRING: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">uppercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, toupper(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">lowercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, tolower(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fail_on_purpose</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
} 

</code></pre></div><p>.\ex48b\c-skeleton\tests\libex29_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>lib_function) (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data);
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>lib_file <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">build/libYOUR_LIBRARY.so</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>lib <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_function</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>func_to_run, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data,
        <span style="color:#66d9ef">int</span> expected)
{
    lib_function func <span style="color:#f92672">=</span> dlsym(lib, func_to_run);
    check(func <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Did not find %s function in the library %s: %s</span><span style="color:#e6db74">&#34;</span>, func_to_run,
            lib_file, dlerror());

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> func(data);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expected, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Function %s return %d for data: %s</span><span style="color:#e6db74">&#34;</span>,
            func_to_run, rc, data);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlopen</span>()
{
    lib <span style="color:#f92672">=</span> dlopen(lib_file, RTLD_NOW);
    mu_assert(lib <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open the library to test.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_functions</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_failures</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose should fail.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlclose</span>()
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> dlclose(lib);
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close lib.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dlopen);
    mu_run_test(test_functions);
    mu_run_test(test_failures);
    mu_run_test(test_dlclose);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\statserve</p>
<p>.\ex48b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

</code></pre></div><p>.\ex48b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// need a ringbuffer for the input
</span><span style="color:#75715e"></span>    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    <span style="color:#75715e">// read_some in a loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// write_it back off the ringbuffer
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(write_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
            debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sock_rb) RingBuffer_destroy(sock_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dummy</span>()
{
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dummy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Solution</p>
<p>The Plan</p>
<p>Show you how I solved the <em>statserve</em> project.</p>
<p>The Purpose</p>
<p>Watch me solve the first project quickly, then review the code.</p>
<p>The Setup</p>
<p>First I need to install liblcthw since I'll be using that.</p>
<p>Then I make the project skeleton and get something, anything going.</p>
<p>The Server</p>
<p>Then I just get it accepting a connection.</p>
<p>The Echo</p>
<p>Then I decided to just make it echo back what I type.</p>
<p>The Final Code</p>

    </div>

    <div class="toc toc-fixed" >
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#exercise-41-project-devpkg">Exercise 41 Project devpkg</a></li>
        <li><a href="#exercise-42-stacks-and-queues">Exercise 42 Stacks and Queues</a></li>
        <li><a href="#exercise-43-a-simple-statistics-engine">Exercise 43 A Simple Statistics Engine</a></li>
        <li><a href="#exercise-44-ring-buffer">Exercise 44 Ring Buffer</a></li>
        <li><a href="#exercise-45-a-simple-tcpip-client">Exercise 45 A Simple TCP/IP Client</a></li>
        <li><a href="#exercise-46-ternary-search-tree">Exercise 46 Ternary Search Tree</a></li>
        <li><a href="#exercise-47-a-fast-url-router">Exercise 47 A Fast URL Router</a></li>
        <li><a href="#exercise-48a-a-simple-network-server">Exercise 48a A Simple Network Server:</a></li>
        <li><a href="#exercise-48b-a-simple-network-server">Exercise 48b A Simple Network Server:</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

</div>

    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/coding/c/lcthw-lectures.2/" title="C Lecture - 2"> <i class="fa fa-chevron-left"></i><label>C Lecture - 2</label></a>
    <a class="nav nav-next" href="/coding/c/lcthw-lectures.4/" title="C Lecture - 4" style="margin-right: 0px;"><label>C Lecture - 4</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

    

    
  </div>


	<div>


  
    
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>


<link href="/css/github.css" rel="stylesheet">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="/theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>