<!DOCTYPE html>
<html>
  <head>
    <title>Hello World</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2020-02-16T13:41:22 AEDT">
<title>C Lecture - 4 :: Hello World</title>
<link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/theme-flex/style.css" rel="stylesheet">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "\/";
</script>
<meta name="description" content="Exercise 48 ~ 51">



    
  </head>
  <body data-url="/coding/c/lcthw-lectures.4/">
    
      <header>
  <div class="logo">
    
	
  
    <a class="baselink" href="/">Hello World</a>
  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
  <nav class="shortcuts">
    <div>
      <div class="searchbox">
        <input data-search-input id="search-by" type="text" placeholder="Search...">
      </div>
      <script type="text/javascript" src="/js/lunr.min.js"></script>
      <script type="text/javascript" src="/js/auto-complete.js"></script>
      <link href="/css/auto-complete.css" rel="stylesheet">
      <script type="text/javascript">
        
            var baseurl = "\/";
        
      </script>
      <script type="text/javascript" src="/js/search.js"></script>
    </div>
  </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/" class="dd-item">
          <a href="/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="/projects/" class="dd-item haschildren
        ">
      <div>
      <a href="/projects/">Projects</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/projects/python-flat-api/" class="dd-item">
        <div>
          <a href="/projects/python-flat-api/">
            FlatApi - Restful API for python dev
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/angular4-crm/" class="dd-item">
        <div>
          <a href="/projects/angular4-crm/">
            Angular 4 CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/laravel-mvc-starter/" class="dd-item">
        <div>
          <a href="/projects/laravel-mvc-starter/">
            Laravel MVC Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/react-crm/" class="dd-item">
        <div>
          <a href="/projects/react-crm/">
            React Redux CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/vue2-admin/" class="dd-item">
        <div>
          <a href="/projects/vue2-admin/">
            Vue 2 Admin Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/vue2-crm/" class="dd-item">
        <div>
          <a href="/projects/vue2-crm/">
            Vue 2 CRM Project
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/angularjs-webpack-es6-starter/" class="dd-item">
        <div>
          <a href="/projects/angularjs-webpack-es6-starter/">
            Angularjs Webpack ES6 Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/zf2-mvc-starter/" class="dd-item">
        <div>
          <a href="/projects/zf2-mvc-starter/">
            Zend Framework 2 MVC Starter
          </a>
        </div>
    </li>
      <li data-nav-id="/projects/kube-cluster/" class="dd-item">
        <div>
          <a href="/projects/kube-cluster/">
            Kubernetes Cluster in 5min
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/coding/">Coding</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
    <li data-nav-id="/coding/c/" class="dd-item parent haschildren
        ">
      <div>
      <a href="/coding/c/">C </a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/c/lcthw-lectures.1/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.1/">
            C Lecture - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.2/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.2/">
            C Lecture - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.3/" class="dd-item">
        <div>
          <a href="/coding/c/lcthw-lectures.3/">
            C Lecture - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c/lcthw-lectures.4/" class="dd-item active">
        <div>
          <a href="/coding/c/lcthw-lectures.4/">
            C Lecture - 4
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/c-sharp/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/c-sharp/">C#</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/c-sharp/csharp-note-1/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-1/">
            C# Console App
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-4/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-4/">
             Generic Predicate &amp; Expression
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-2/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-2/">
            Scheduled task with window service
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/c-sharp/csharp-note-3/" class="dd-item">
        <div>
          <a href="/coding/c-sharp/csharp-note-3/">
            Thread &amp; Task
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/db-sql/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/db-sql/">DB &amp; SQL</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/db-sql/mysql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-1/">
            MySql Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-2/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-2/">
            MySql Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-3/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-3/">
            MySql Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-4/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-4/">
            MySql Note - 4
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mysql-note-5/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mysql-note-5/">
            MySql Note - 5
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/pgsql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/pgsql-note-1/">
            PostgresQL Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/db-sql/mssql-note-1/" class="dd-item">
        <div>
          <a href="/coding/db-sql/mssql-note-1/">
            Sql Server Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/golang/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/golang/">Golang</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/golang/go-note-1/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-1/">
            Getting started
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-2/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-2/">
            Map, Function &amp; Closure
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-3/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-3/">
            Struct &amp; Interface
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-4/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-4/">
            IO, Json &amp; XML
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-5/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-5/">
            Error handling
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-6/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-6/">
            Goroutine &amp; Channel - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-7/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-7/">
            Goroutine &amp; Channel - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-8/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-8/">
            Packaging
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-9/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-9/">
            Pitfalls
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-10/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-10/">
            Template
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-20/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-20/">
            Good practice - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-21/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-21/">
            Good practice 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-22/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-22/">
            Good practice 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/golang/go-note-99/" class="dd-item">
        <div>
          <a href="/coding/golang/go-note-99/">
            Golang snippets
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/java/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/java/">Java</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/java/java-note-1/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-1/">
            Java Note - 1: Enum
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-2/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-2/">
            Java Note - 2: Concurrency
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-3/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-3/">
            Java Note - 3: Path and Files
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-4/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-4/">
            Java Note - 4: Date Time 
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/java/java-note-5/" class="dd-item">
        <div>
          <a href="/coding/java/java-note-5/">
            Java Note - 5: Lambda 
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/js-ts/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/js-ts/">JS &amp; TS </a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/js-ts/js-note-1/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-1/">
            JS &amp; ES Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-2/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-2/">
            JS &amp; ES Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-3/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-3/">
            JS &amp; ES Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/js-note-99/" class="dd-item">
        <div>
          <a href="/coding/js-ts/js-note-99/">
            JS &amp; ES snippet
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/js-ts/ts-note-1/" class="dd-item">
        <div>
          <a href="/coding/js-ts/ts-note-1/">
            TypeScript Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/python/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/python/">Python</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/python/python-note-1/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-1/">
            Package &amp; Module
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-2/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-2/">
            Closure &amp; Decorator
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-3/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-3/">
            String &amp; Representation
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-4/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-4/">
            Iteration
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-5/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-5/">
            Inheritance &amp; Polymorphism
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-6/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-6/">
            Collection
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-7/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-7/">
            Exception &amp; Assertion
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-8/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-8/">
            Context
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/python/python-note-9/" class="dd-item">
        <div>
          <a href="/coding/python/python-note-9/">
            ABC
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/rustlang/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/rustlang/">Rustlang</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/rustlang/rust-note-1/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-1/">
            Data Types &amp; Ownership
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-2/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-2/">
            Project, Vector, String &amp; Hashmap
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-3/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-3/">
            Error handling
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/rustlang/rust-note-4/" class="dd-item">
        <div>
          <a href="/coding/rustlang/rust-note-4/">
            Generic Type &amp; Trait 
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/coding/shell/" class="dd-item haschildren
        ">
      <div>
      <a href="/coding/shell/">Shell</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/coding/shell/bash-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-1/">
            Adv Bash - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/bash-note-2/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-2/">
            Adv Bash - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/bash-note-3/" class="dd-item">
        <div>
          <a href="/coding/shell/bash-note-3/">
            Adv Bash - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/cron-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/cron-note-1/">
            Cron Job Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/cron-note-2/" class="dd-item">
        <div>
          <a href="/coding/shell/cron-note-2/">
            Cron Job Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/coding/shell/ps-note-1/" class="dd-item">
        <div>
          <a href="/coding/shell/ps-note-1/">
            Powershell Note - 1
          </a>
        </div>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/cloud/" class="dd-item haschildren
        ">
      <div>
      <a href="/cloud/">Cloud</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/cloud/aws-note-1/" class="dd-item">
        <div>
          <a href="/cloud/aws-note-1/">
            AWS Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/aws-note-2/" class="dd-item">
        <div>
          <a href="/cloud/aws-note-2/">
            AWS Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-1/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-1/">
            DigitialOcean Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-2/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-2/">
            DigitialOcean Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-3/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-3/">
            DigitialOcean Note - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/cloud/digito-note-4/" class="dd-item">
        <div>
          <a href="/cloud/digito-note-4/">
            DigitialOcean Note - 4
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/hacks/" class="dd-item haschildren
        ">
      <div>
      <a href="/hacks/">Hacks</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/hacks/git-notes/" class="dd-item">
        <div>
          <a href="/hacks/git-notes/">
            Git Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-3/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-3/">
            Windows cmd &amp; hotkey - 3
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-2/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-2/">
            Windows cmd &amp; hotkey - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/windows-command-1/" class="dd-item">
        <div>
          <a href="/hacks/windows-command-1/">
            Windows cmd &amp; hotkey - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/cass-note/" class="dd-item">
        <div>
          <a href="/hacks/cass-note/">
            Cassandra Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/php-debug/" class="dd-item">
        <div>
          <a href="/hacks/php-debug/">
            Debug PHP with Free IDE
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/qemu-notes/" class="dd-item">
        <div>
          <a href="/hacks/qemu-notes/">
            Qemu &amp; Virtual Machine
          </a>
        </div>
    </li>
      <li data-nav-id="/hacks/vbox-notes/" class="dd-item">
        <div>
          <a href="/hacks/vbox-notes/">
            VirtualBox Notes
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/os/" class="dd-item haschildren
        ">
      <div>
      <a href="/os/">OS</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/os/dual-boot-win10-ubuntu18/" class="dd-item">
        <div>
          <a href="/os/dual-boot-win10-ubuntu18/">
            Dual Boot Windows 10 &amp; Ubuntu 18
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-18/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-18/">
            Ubuntu Desktop 18 LTS note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/raspberrypi-notes/" class="dd-item">
        <div>
          <a href="/os/raspberrypi-notes/">
            Raspberry Pi setup
          </a>
        </div>
    </li>
      <li data-nav-id="/os/lubuntu16-desktop/" class="dd-item">
        <div>
          <a href="/os/lubuntu16-desktop/">
            Lubuntu 16 desktop
          </a>
        </div>
    </li>
      <li data-nav-id="/os/grub-trouble-shooting/" class="dd-item">
        <div>
          <a href="/os/grub-trouble-shooting/">
            Grub Trouble Shooting
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-server-16/" class="dd-item">
        <div>
          <a href="/os/ubuntu-server-16/">
            Ubuntu 16 server note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/centos-server-7/" class="dd-item">
        <div>
          <a href="/os/centos-server-7/">
            CentOS 7 Server note
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-server-14/" class="dd-item">
        <div>
          <a href="/os/ubuntu-server-14/">
            Ubuntu 14 -- server setup
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-14/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-14/">
            Ubuntu 14 -- desktop setup &amp; dual boot 
          </a>
        </div>
    </li>
      <li data-nav-id="/os/ubuntu-desktop-14-extra-tools/" class="dd-item">
        <div>
          <a href="/os/ubuntu-desktop-14-extra-tools/">
            Ubuntu 14 -- desktop, extra tools
          </a>
        </div>
    </li>
      <li data-nav-id="/os/centos-fedora-desktop/" class="dd-item">
        <div>
          <a href="/os/centos-fedora-desktop/">
            CentOS 6/7 Multi-Boot Setup
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/blogs/" class="dd-item haschildren
        ">
      <div>
      <a href="/blogs/">Blogs</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/blogs/k8s-on-vm/" class="dd-item">
        <div>
          <a href="/blogs/k8s-on-vm/">
            Try Minikube
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/vue-ng-react/" class="dd-item">
        <div>
          <a href="/blogs/vue-ng-react/">
            Angular vs React vs Vue
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/create-a-blog-on-github/" class="dd-item">
        <div>
          <a href="/blogs/create-a-blog-on-github/">
            Create a blog site on GitHub Pages
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/build-mobile-app/" class="dd-item">
        <div>
          <a href="/blogs/build-mobile-app/">
            Build mobile app with web tech
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/azure-notes/" class="dd-item">
        <div>
          <a href="/blogs/azure-notes/">
            Azure Practices
          </a>
        </div>
    </li>
      <li data-nav-id="/blogs/javascript-oop/" class="dd-item">
        <div>
          <a href="/blogs/javascript-oop/">
            JavaScript and OOP
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/frameworks/" class="dd-item haschildren
        ">
      <div>
      <a href="/frameworks/">Frameworks</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/frameworks/cntk-notes-1/" class="dd-item">
        <div>
          <a href="/frameworks/cntk-notes-1/">
            CNTK Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/tensorflow-notes-1/" class="dd-item">
        <div>
          <a href="/frameworks/tensorflow-notes-1/">
            Tensorflow Note - 1
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/tensorflow-notes-2/" class="dd-item">
        <div>
          <a href="/frameworks/tensorflow-notes-2/">
            Tensorflow Note - 2
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/php-web/" class="dd-item">
        <div>
          <a href="/frameworks/php-web/">
            PHP Web Framework
          </a>
        </div>
    </li>
      <li data-nav-id="/frameworks/python-django/" class="dd-item">
        <div>
          <a href="/frameworks/python-django/">
            Python Web Framework
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="/tut/" class="dd-item haschildren
        ">
      <div>
      <a href="/tut/">Tutorial</a><i class="fa fa-angle-right fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="/tut/docker/" class="dd-item">
        <div>
          <a href="/tut/docker/">
            Docker Tutorial
          </a>
        </div>
    </li>
      <li data-nav-id="/tut/javascript/" class="dd-item">
        <div>
          <a href="/tut/javascript/">
            JavaScript Tutorial
          </a>
        </div>
    </li>
      <li data-nav-id="/tut/kube/" class="dd-item">
        <div>
          <a href="/tut/kube/">
            Kubernetes Tutorial
          </a>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/projects/" >
   Projects</option>
    <option value="/coding/" >
   Coding</option> 
    <option value="/coding/c/" >
  - 
   C </option> 
      <option value="/coding/c/lcthw-lectures.1/" >-- C Lecture - 1</option>
      <option value="/coding/c/lcthw-lectures.2/" >-- C Lecture - 2</option>
      <option value="/coding/c/lcthw-lectures.3/" >-- C Lecture - 3</option>
      <option value="/coding/c/lcthw-lectures.4/"  selected>-- C Lecture - 4</option>
  
    <option value="/coding/c-sharp/" >
  - 
   C#</option>
    <option value="/coding/db-sql/" >
  - 
   DB &amp; SQL</option>
    <option value="/coding/golang/" >
  - 
   Golang</option>
    <option value="/coding/java/" >
  - 
   Java</option>
    <option value="/coding/js-ts/" >
  - 
   JS &amp; TS </option>
    <option value="/coding/python/" >
  - 
   Python</option>
    <option value="/coding/rustlang/" >
  - 
   Rustlang</option>
    <option value="/coding/shell/" >
  - 
   Shell</option>
  
    <option value="/cloud/" >
   Cloud</option>
    <option value="/hacks/" >
   Hacks</option>
    <option value="/os/" >
   OS</option>
    <option value="/blogs/" >
   Blogs</option>
    <option value="/frameworks/" >
   Frameworks</option>
    <option value="/tut/" >
   Tutorial</option>



        </select>
      </center>
    </div>


    


    
    
    
<div class="main-page">
    <div class="flex-item main-content">
            <h1>C Lecture - 4</h1>
        <p>Author: Zed A. Shaw</p>
<p>All content comes from Zed's <a href="https://github.com/zedshaw/learn-c-the-hard-way-lectures.git">Lecture Repository</a> and <a href="https://github.com/zedshaw/liblcthw">Libraries Repository</a>.  All credit goes to Zed.</p>
<h3 id="exercise-48a-a-simple-network-server">Exercise 48a A Simple Network Server:</h3>
<p>Project Description</p>
<p>The Plan</p>
<p>Start your first long running project:</p>
<p>statserve</p>
<p>The Purpose</p>
<p>You'll get the project started and get a minimum first hack going.</p>
<p>The Requirements</p>
<ol>
<li>Create a simple network server that accepts a connection on port 7899 from
<em>netclient</em> or the <em>nc</em> command, and echoes back anything you type.</li>
<li>You'll need to learn how to bind a port, listen on the socket, and answer it.
Use your research skills to study how this is done and attempt to implement it
yourself.</li>
</ol>
<p>The Requirements</p>
<ol start="3">
<li>The more important part of this project is laying out the project directory
from the <em>c-skeleton</em>, and making sure you can build everything and get it
working.</li>
<li>Don't worry about things like daemons or anything else.  Your server just has
to run from the command line and keep running.</li>
</ol>
<p>The Clues</p>
<p>I will now give you some clues:</p>
<ul>
<li>USE liblcthw!</li>
<li>Remember you did a client already, you just need to make a server.</li>
<li>Do NOT use select! Use fork() for the server.</li>
<li>Keep it <em>simple</em>.  Don't worry about anything other than accepting a connection and closing.</li>
<li>Stay small, build slowly.</li>
</ul>
<p>Important References</p>
<ul>
<li>Research online for &ldquo;echo server in C&rdquo;.</li>
<li>Read man (2) pages for <em>accept</em>, <em>bind</em>, <em>listen</em>, <em>connect</em>, <em>select</em>, <em>socket</em>, and <em>shutdown</em>.</li>
</ul>
<p>Encouragement</p>
<p>This will be <em>HARD</em>!  Try it your best, and take it piece by piece.  You can do it, but remember if you give up the next video (48b) will show you the code to my solution and how to solve it.  You can peek there then come back when you're stuck.</p>
<h3 id="exercise-48b-a-simple-network-server">Exercise 48b A Simple Network Server:</h3>
<p>.\ex48b\c-skeleton</p>
<p>.\ex48b\c-skeleton\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\c-skeleton\src\libex29.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_a_message</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A STRING: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">uppercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, toupper(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">lowercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, tolower(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fail_on_purpose</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
} 

</code></pre></div><p>.\ex48b\c-skeleton\tests\libex29_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>lib_function) (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data);
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>lib_file <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">build/libYOUR_LIBRARY.so</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>lib <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_function</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>func_to_run, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data,
        <span style="color:#66d9ef">int</span> expected)
{
    lib_function func <span style="color:#f92672">=</span> dlsym(lib, func_to_run);
    check(func <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Did not find %s function in the library %s: %s</span><span style="color:#e6db74">&#34;</span>, func_to_run,
            lib_file, dlerror());

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> func(data);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expected, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Function %s return %d for data: %s</span><span style="color:#e6db74">&#34;</span>,
            func_to_run, rc, data);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlopen</span>()
{
    lib <span style="color:#f92672">=</span> dlopen(lib_file, RTLD_NOW);
    mu_assert(lib <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open the library to test.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_functions</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_failures</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose should fail.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlclose</span>()
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> dlclose(lib);
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close lib.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dlopen);
    mu_run_test(test_functions);
    mu_run_test(test_failures);
    mu_run_test(test_dlclose);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\statserve</p>
<p>.\ex48b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

</code></pre></div><p>.\ex48b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// need a ringbuffer for the input
</span><span style="color:#75715e"></span>    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    <span style="color:#75715e">// read_some in a loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// write_it back off the ringbuffer
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(write_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
            debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sock_rb) RingBuffer_destroy(sock_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dummy</span>()
{
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dummy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\c-skeleton</p>
<p>.\ex48b\c-skeleton\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\c-skeleton\src\libex29.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;dbg.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_a_message</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A STRING: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">uppercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, toupper(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">lowercase</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// BUG: \0 termination problems
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; msg[i] <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span>, tolower(msg[i]));
    }

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fail_on_purpose</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
} 

</code></pre></div><p>.\ex48b\c-skeleton\tests\libex29_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>lib_function) (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data);
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>lib_file <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">build/libYOUR_LIBRARY.so</span><span style="color:#e6db74">&#34;</span>;
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>lib <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_function</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>func_to_run, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data,
        <span style="color:#66d9ef">int</span> expected)
{
    lib_function func <span style="color:#f92672">=</span> dlsym(lib, func_to_run);
    check(func <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Did not find %s function in the library %s: %s</span><span style="color:#e6db74">&#34;</span>, func_to_run,
            lib_file, dlerror());

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> func(data);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> expected, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Function %s return %d for data: %s</span><span style="color:#e6db74">&#34;</span>,
            func_to_run, rc, data);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlopen</span>()
{
    lib <span style="color:#f92672">=</span> dlopen(lib_file, RTLD_NOW);
    mu_assert(lib <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to open the library to test.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_functions</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">print_a_message failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">uppercase failed.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">0</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowercase failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_failures</span>()
{
    mu_assert(check_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Hello</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>),
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">fail_on_purpose should fail.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dlclose</span>()
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> dlclose(lib);
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close lib.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dlopen);
    mu_run_test(test_functions);
    mu_run_test(test_failures);
    mu_run_test(test_dlclose);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex48b\statserve</p>
<p>.\ex48b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

</code></pre></div><p>.\ex48b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// need a ringbuffer for the input
</span><span style="color:#75715e"></span>    RingBuffer <span style="color:#f92672">*</span>sock_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    <span style="color:#75715e">// read_some in a loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// write_it back off the ringbuffer
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(write_some(sock_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
            debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(sock_rb) RingBuffer_destroy(sock_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex48b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex48b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_dummy</span>()
{
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    mu_run_test(test_dummy);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Solution</p>
<p>The Plan</p>
<p>Show you how I solved the <em>statserve</em> project.</p>
<p>The Purpose</p>
<p>Watch me solve the first project quickly, then review the code.</p>
<p>The Setup</p>
<p>First I need to install liblcthw since I'll be using that.</p>
<p>Then I make the project skeleton and get something, anything going.</p>
<p>The Server</p>
<p>Then I just get it accepting a connection.</p>
<p>The Echo</p>
<p>Then I decided to just make it echo back what I type.</p>
<p>The Final Code</p>
<h3 id="exercise-49a-a-statistics-server">Exercise 49a A Statistics Server</h3>
<p>Project Description</p>
<p>The Plan</p>
<p>Make the <em>statsserver</em> do something using a simple protocol.</p>
<p>The Purpose</p>
<p>Learn the first steps in creating a server that answers a protocol.</p>
<p>The Requirements</p>
<p>Create this protocol:</p>
<pre><code>create Create a new statistic.
mean   Get the current mean of a statistic.
sample Add a new sample to a statistics.
dump   Get all of the elements of a statistic (sum, sumsq, n, min, and max).
</code></pre>
<p>The Requirements</p>
<ol>
<li>You'll need to allow people to name these statistics, which means using one of the map style data structures to map names to <code>Stats</code> structs.</li>
<li>You'll need to add the <code>CRUD</code> standard operations for each name.  CRUD stands for create read update delete.  Currently, the list of commands above has create, mean, and dump for reading; and sample for updating.  You need a delete command now.</li>
<li>Make the protocol <em>strict</em>! Abort any client that makes any mistakes in protocols.</li>
</ol>
<p>Strict Protocol</p>
<p>Once again, in case you missed it, be ruthless!</p>
<p>Abort all deviant clients.</p>
<p>Pause!</p>
<p>I'm going to give you clues to solve this, so if you want to try on your own pause now!</p>
<p>The Clues</p>
<ul>
<li>Create the data structures first for holding the information for each of these commands.</li>
<li>Then write a protocol parser to handle it and fill in the data.</li>
<li>Then pass that data to a function that knows how to do that command.</li>
<li>You can just store the stats in a Hashmap, BSTree, or TSTree for now.</li>
<li>KEEP IT SIMPLE!</li>
</ul>
<p>Important References</p>
<ul>
<li>You'll want to refer to the bstring documentation as much as possible to know what functions to use.</li>
</ul>
<p>Encouragement</p>
<ul>
<li>Remember that this is <em>supposed</em> to be hard.</li>
<li>You are <em>supposed</em> to struggle with this.</li>
<li>This could take you a while, but keep up the struggle, do it bit by bit, and test little pieces as you go.</li>
<li>Automate your tests!</li>
</ul>
<h3 id="exercise-49b-a-statistics-server">Exercise 49b A Statistics Server:</h3>
<p>.\ex49b\statserve</p>
<p>.\ex49b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex49b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    <span style="color:#75715e">// not super efficient
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// read a character at a time from the ring buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> RingBuffer_available_data(input); i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#75715e">// if the buffer has line ending
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(input<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>buffer[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> line_ending) {
            <span style="color:#75715e">// get that much fromt he ring buffer
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> RingBuffer_gets(input, i);
            check(result, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get line from RingBuffer</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// make sure that we got the right amount
</span><span style="color:#75715e"></span>            check(RingBuffer_available_data(input) <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not enough data in the RingBuffer after reading line.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// and commit it
</span><span style="color:#75715e"></span>            RingBuffer_commit_read(input, <span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// notice this will fail in the cases where we get a set of data
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on the wire that does not have a line ending yet
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> result;
error:
    <span style="color:#66d9ef">return</span> NULL;
}

</code></pre></div><p>.\ex49b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/hashmap.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring LINE_SPLIT <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CREATE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring STDDEV <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring MEAN <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SAMPLE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DUMP <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DELETE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring OK <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring ERR <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ERR</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DNE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">DNE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring EXISTS <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">EXISTS</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> LINE_ENDING <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

Hashmap <span style="color:#f92672">*</span>DATA <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">struct</span> Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>handler_cb)(<span style="color:#66d9ef">struct</span> Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Command {
    bstring command;
    bstring name;
    bstring number;
    handler_cb handler;
} Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Record {
    bstring name;
    Stats <span style="color:#f92672">*</span>stat;
} Record;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply)
{
    RingBuffer_puts(send_rb, reply);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_create</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// if the name is in the DATA map then return exists
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name)) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>EXISTS);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// allocate a recrod
</span><span style="color:#75715e"></span>        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

        Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> calloc(<span style="color:#66d9ef">sizeof</span>(Record), <span style="color:#ae81ff">1</span>);
        check_mem(info);

        <span style="color:#75715e">// set its stat element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat <span style="color:#f92672">=</span> Stats_create();
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);

        <span style="color:#75715e">// set its name element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> bstrcpy(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        <span style="color:#75715e">// do a first sample
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));

        <span style="color:#75715e">// add it to the hashmap
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> Hashmap_set(DATA, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, info);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add data to map.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// send an OK
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_sample</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#75715e">// get the info from the hashmap
</span><span style="color:#75715e"></span>    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        <span style="color:#75715e">// if it doesn&#39;t exist then DNE
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// else run sample on it, return the mean
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_delete</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        Hashmap_delete(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        free(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);
        bdestroy(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        free(info);

        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_mean</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_stddev</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_dump</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f %f %f %f %ld %f %f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max);

        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_command</span>(<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits, Command <span style="color:#f92672">*</span>cmd)
{
    <span style="color:#75715e">// get the command
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>CREATE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse create: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_create;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>MEAN)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse mean: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_mean;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>SAMPLE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse sample: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_sample;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DUMP)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse dump: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_dump;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DELETE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse delete: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_delete;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>STDDEV)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse stddev: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_stddev;
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse the command.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    Command cmd <span style="color:#f92672">=</span> {.command <span style="color:#f92672">=</span> NULL};

    <span style="color:#75715e">// split data on line boundaries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits <span style="color:#f92672">=</span> bsplits(data, <span style="color:#f92672">&amp;</span>LINE_SPLIT);
    check(splits <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad data.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// parse it into a command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> parse_command(splits, <span style="color:#f92672">&amp;</span>cmd);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// call the command handler for that command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> cmd.handler(<span style="color:#f92672">&amp;</span>cmd, send_rb);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(splits) bstrListDestroy(splits);
    <span style="color:#66d9ef">return</span> rc;

}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>recv_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    check_mem(recv_rb);
    check_mem(send_rb);

    <span style="color:#75715e">// keep reading into the recv buffer and sending on send
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(recv_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// read a line from the recv_rb
</span><span style="color:#75715e"></span>        bstring data <span style="color:#f92672">=</span> read_line(recv_rb, LINE_ENDING);
        check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// parse it, close on any protocol errors
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> parse_line(data, send_rb);
        bdestroy(data); <span style="color:#75715e">// cleanup here
</span><span style="color:#75715e"></span>        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse user. Closing.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// and as long as there&#39;s something to send, send it
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(RingBuffer_available_data(send_rb)) {
            write_some(send_rb, client_fd, <span style="color:#ae81ff">1</span>);
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(recv_rb) RingBuffer_destroy(recv_rb);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>()
{
    <span style="color:#75715e">// a more advanced design simply wouldn&#39;t use this
</span><span style="color:#75715e"></span>    DATA <span style="color:#f92672">=</span> Hashmap_create(NULL, NULL);
    check_mem(DATA);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rc <span style="color:#f92672">=</span> setup_data_store();
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex49b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring OK;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>();

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> LineTest {
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>line;
    bstring result;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>description;
} LineTest;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_line</span>(LineTest test)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    bstring line <span style="color:#f92672">=</span> bfromcstr(test.line);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);

    rc <span style="color:#f92672">=</span> parse_line(line, send_rb);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse line.</span><span style="color:#e6db74">&#34;</span>);

    result <span style="color:#f92672">=</span> RingBuffer_get_all(send_rb);
    check(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Ring buffer empty.</span><span style="color:#e6db74">&#34;</span>);
    check(biseq(result, test.result), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got the wrong output: %s expected %s</span><span style="color:#e6db74">&#34;</span>,
            bdata(result), bdata(test.result));

    bdestroy(line);
    RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// using 1 for tests
</span><span style="color:#75715e"></span>error:

    log_err(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process test %s: got %s</span><span style="color:#e6db74">&#34;</span>, test.line, bdata(result));
    <span style="color:#66d9ef">if</span>(line) bdestroy(line);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_test_lines</span>(LineTest <span style="color:#f92672">*</span>tests, <span style="color:#66d9ef">int</span> count)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        check(attempt_line(tests[i]), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run %s</span><span style="color:#e6db74">&#34;</span>, tests[i].description);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /joe 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create joe failed</span><span style="color:#e6db74">&#34;</span>},

    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">2</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run create tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_sample</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring sample1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">100.000000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>sample1, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample zed failed.</span><span style="color:#e6db74">&#34;</span>}
    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">1</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run sample tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> setup_data_store();
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    mu_run_test(test_create);
    mu_run_test(test_sample);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>.\ex49b\statserve</p>
<p>.\ex49b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex49b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    <span style="color:#75715e">// not super efficient
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// read a character at a time from the ring buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> RingBuffer_available_data(input); i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#75715e">// if the buffer has line ending
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(input<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>buffer[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> line_ending) {
            <span style="color:#75715e">// get that much fromt he ring buffer
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> RingBuffer_gets(input, i);
            check(result, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get line from RingBuffer</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// make sure that we got the right amount
</span><span style="color:#75715e"></span>            check(RingBuffer_available_data(input) <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not enough data in the RingBuffer after reading line.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// and commit it
</span><span style="color:#75715e"></span>            RingBuffer_commit_read(input, <span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// notice this will fail in the cases where we get a set of data
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on the wire that does not have a line ending yet
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> result;
error:
    <span style="color:#66d9ef">return</span> NULL;
}

</code></pre></div><p>.\ex49b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/hashmap.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring LINE_SPLIT <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CREATE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring STDDEV <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring MEAN <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SAMPLE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DUMP <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DELETE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring OK <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring ERR <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ERR</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DNE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">DNE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring EXISTS <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">EXISTS</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> LINE_ENDING <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

Hashmap <span style="color:#f92672">*</span>DATA <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">struct</span> Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>handler_cb)(<span style="color:#66d9ef">struct</span> Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Command {
    bstring command;
    bstring name;
    bstring number;
    handler_cb handler;
} Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Record {
    bstring name;
    Stats <span style="color:#f92672">*</span>stat;
} Record;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply)
{
    RingBuffer_puts(send_rb, reply);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_create</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// if the name is in the DATA map then return exists
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name)) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>EXISTS);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// allocate a recrod
</span><span style="color:#75715e"></span>        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

        Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> calloc(<span style="color:#66d9ef">sizeof</span>(Record), <span style="color:#ae81ff">1</span>);
        check_mem(info);

        <span style="color:#75715e">// set its stat element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat <span style="color:#f92672">=</span> Stats_create();
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);

        <span style="color:#75715e">// set its name element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> bstrcpy(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        <span style="color:#75715e">// do a first sample
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));

        <span style="color:#75715e">// add it to the hashmap
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> Hashmap_set(DATA, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, info);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add data to map.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// send an OK
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_sample</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#75715e">// get the info from the hashmap
</span><span style="color:#75715e"></span>    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        <span style="color:#75715e">// if it doesn&#39;t exist then DNE
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// else run sample on it, return the mean
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_delete</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        Hashmap_delete(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        free(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);
        bdestroy(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        free(info);

        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_mean</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_stddev</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_dump</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f %f %f %f %ld %f %f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max);

        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_command</span>(<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits, Command <span style="color:#f92672">*</span>cmd)
{
    <span style="color:#75715e">// get the command
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>CREATE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse create: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_create;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>MEAN)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse mean: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_mean;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>SAMPLE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse sample: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_sample;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DUMP)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse dump: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_dump;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DELETE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse delete: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_delete;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>STDDEV)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse stddev: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_stddev;
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse the command.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    Command cmd <span style="color:#f92672">=</span> {.command <span style="color:#f92672">=</span> NULL};

    <span style="color:#75715e">// split data on line boundaries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits <span style="color:#f92672">=</span> bsplits(data, <span style="color:#f92672">&amp;</span>LINE_SPLIT);
    check(splits <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad data.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// parse it into a command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> parse_command(splits, <span style="color:#f92672">&amp;</span>cmd);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// call the command handler for that command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> cmd.handler(<span style="color:#f92672">&amp;</span>cmd, send_rb);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(splits) bstrListDestroy(splits);
    <span style="color:#66d9ef">return</span> rc;

}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>recv_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    check_mem(recv_rb);
    check_mem(send_rb);

    <span style="color:#75715e">// keep reading into the recv buffer and sending on send
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(recv_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// read a line from the recv_rb
</span><span style="color:#75715e"></span>        bstring data <span style="color:#f92672">=</span> read_line(recv_rb, LINE_ENDING);
        check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// parse it, close on any protocol errors
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> parse_line(data, send_rb);
        bdestroy(data); <span style="color:#75715e">// cleanup here
</span><span style="color:#75715e"></span>        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse user. Closing.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// and as long as there&#39;s something to send, send it
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(RingBuffer_available_data(send_rb)) {
            write_some(send_rb, client_fd, <span style="color:#ae81ff">1</span>);
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(recv_rb) RingBuffer_destroy(recv_rb);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>()
{
    <span style="color:#75715e">// a more advanced design simply wouldn&#39;t use this
</span><span style="color:#75715e"></span>    DATA <span style="color:#f92672">=</span> Hashmap_create(NULL, NULL);
    check_mem(DATA);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rc <span style="color:#f92672">=</span> setup_data_store();
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex49b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring OK;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>();

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex49b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> LineTest {
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>line;
    bstring result;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>description;
} LineTest;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_line</span>(LineTest test)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    bstring line <span style="color:#f92672">=</span> bfromcstr(test.line);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);

    rc <span style="color:#f92672">=</span> parse_line(line, send_rb);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse line.</span><span style="color:#e6db74">&#34;</span>);

    result <span style="color:#f92672">=</span> RingBuffer_get_all(send_rb);
    check(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Ring buffer empty.</span><span style="color:#e6db74">&#34;</span>);
    check(biseq(result, test.result), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got the wrong output: %s expected %s</span><span style="color:#e6db74">&#34;</span>,
            bdata(result), bdata(test.result));

    bdestroy(line);
    RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// using 1 for tests
</span><span style="color:#75715e"></span>error:

    log_err(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process test %s: got %s</span><span style="color:#e6db74">&#34;</span>, test.line, bdata(result));
    <span style="color:#66d9ef">if</span>(line) bdestroy(line);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_test_lines</span>(LineTest <span style="color:#f92672">*</span>tests, <span style="color:#66d9ef">int</span> count)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        check(attempt_line(tests[i]), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run %s</span><span style="color:#e6db74">&#34;</span>, tests[i].description);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /joe 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create joe failed</span><span style="color:#e6db74">&#34;</span>},

    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">2</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run create tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_sample</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring sample1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">100.000000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>sample1, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample zed failed.</span><span style="color:#e6db74">&#34;</span>}
    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">1</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run sample tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> setup_data_store();
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    mu_run_test(test_create);
    mu_run_test(test_sample);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Solution</p>
<p>The Plan</p>
<p>I'll show you how I implemented the protocol in the smallest code possible.</p>
<p>I won't implement all of the CRUD operations, so you can go look at the
git repo for this project to see a full implementation.</p>
<p>The Setup</p>
<p>First I setup the data, then the protocol parser, then the handlers.</p>
<p>The Protocol</p>
<pre><code>create Create a new statistic.
mean   Get the current mean of a statistic.
sample Add a new sample to a statistics.
dump   Get all of the elements of a statistic (sum, sumsq, n, min, and max).Final Code
</code></pre>
<p>The Command Structure</p>
<pre><code>typedef struct Command {
    bstring command;
    bstring name;
    bstring number;
    handler_cb handler;
} Command;
</code></pre>
<p>The Storage Record</p>
<pre><code>typedef struct Record {
    bstring name;
    Stats *stat;
} Record;
</code></pre>
<p>The Design</p>
<ul>
<li>Accept a connection</li>
<li>Parse the line into the Command</li>
<li>Run a handler function to process it</li>
<li>Temporarily store into a Hashmap</li>
</ul>
<p>Final Thoughts</p>
<p>The last thing I would do is add better tests and round out the protocol with CRUD operations.</p>
<h3 id="exercise-50a-routing-the-statistics">Exercise 50a Routing The Statistics</h3>
<p>Project Description</p>
<p>The Plan</p>
<p>You are now given vague instructions and have to &ldquo;solve&rdquo; as best you can.</p>
<p>The Purpose</p>
<p>To give you freedom to be creative, and also taste a real project with vague
specifications.</p>
<p>Many times all you get is a single sentence in a bug tracker. Oh well.</p>
<p>The Requirements</p>
<p>Allow people to work with statistics at arbitrary URLs in the server.
You get to define what that means, but think &ldquo;web application&rdquo;.</p>
<p>Pause!</p>
<p>Try to solve it on your own then continue.</p>
<p>The Clues</p>
<p>Answer these questions:</p>
<ol>
<li>What happens when I have a statistics &ldquo;under&rdquo; another, as in /age/northamerica/ is under /age/.</li>
<li>Could you do the summary statistics we talked about?  A mean of means and mean of standard deviations that are rolled up the tree?</li>
<li>What data structures do you need?  Starting with data is key here too. Data data data.</li>
<li>Are your tests good enough?  Before you start you might want to get good tests that use the protocol.</li>
</ol>
<p>Important References</p>
<ul>
<li>Definitely look at the statistics code you built in liblcthw if you do the summary statistics.</li>
</ul>
<p>Encouragement</p>
<p>This is hard, as I've said all along, however it is all doable. It's simply a matter of breaking the problems down and tackling each little piece.</p>
<h3 id="exercise-50b-routing-the-statistics">Exercise 50b Routing the Statistics</h3>
<p>Solution</p>
<p>The Plan</p>
<p>Show you how I solved the problem of routing the names of statistics as URLs.</p>
<p>The Setup</p>
<ol>
<li>First thing I did was make sure my tests were really good.</li>
<li>Then I designed the data structures I'd need.</li>
<li>Then I did the work to make them functions.</li>
<li>The protocol shouldn't need to change.</li>
</ol>
<p>&ldquo;URLs&rdquo;</p>
<p>I'll define paths as simply names separated by /.</p>
<p>Real URLs are way more complex than that.</p>
<p>Data Structure</p>
<p>I just added:</p>
<pre><code>struct bstrList *path;
</code></pre>
<p>To the Command struct to hold paths.</p>
<p>URL Meaning</p>
<p>Kind of weird, but:</p>
<pre><code>Deepest part of URL is &quot;parent&quot;, this is the main stat.
Children are next segments up, and are mean-of-mean stats.
</code></pre>
<p>New Processing</p>
<ol>
<li>Change to a loop over all paths with a &ldquo;scan path&rdquo; function.</li>
<li>Add optional path parameter to handlers.</li>
<li>Parse the path in <em>parse_command</em> to set path in Commands.</li>
<li>In sample and create, change root processing vs. child processing.</li>
<li>Move <em>send_reply</em> over to <em>net.c</em> instead.</li>
</ol>
<p>Test First Path Parsing</p>
<p>I'll write a small test for just the <em>scan_paths</em> part first.</p>
<p>Then wire that in and use the existing tests to confirm the old code
works.</p>
<p>The Code</p>
<p>.\ex50b\statserve</p>
<p>.\ex50b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];

    check(echo_server(host, port), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex50b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex50b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    <span style="color:#75715e">// not super efficient
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// read a character at a time from the ring buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> RingBuffer_available_data(input); i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#75715e">// if the buffer has line ending
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(input<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>buffer[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> line_ending) {
            <span style="color:#75715e">// get that much fromt he ring buffer
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> RingBuffer_gets(input, i);
            check(result, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get line from RingBuffer</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// make sure that we got the right amount
</span><span style="color:#75715e"></span>            check(RingBuffer_available_data(input) <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not enough data in the RingBuffer after reading line.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// and commit it
</span><span style="color:#75715e"></span>            RingBuffer_commit_read(input, <span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// notice this will fail in the cases where we get a set of data
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on the wire that does not have a line ending yet
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> result;
error:
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply)
{
    RingBuffer_puts(send_rb, reply);
}

</code></pre></div><p>.\ex50b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex50b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/hashmap.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring LINE_SPLIT <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CREATE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring STDDEV <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring MEAN <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SAMPLE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DUMP <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DELETE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring OK <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring ERR <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ERR</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DNE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">DNE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring EXISTS <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">EXISTS</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SLASH <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> LINE_ENDING <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

Hashmap <span style="color:#f92672">*</span>DATA <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_create</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> is_root <span style="color:#f92672">=</span> biseq(path, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> is_root) {
        <span style="color:#75715e">// report if root exists, just skip children
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>EXISTS);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL) {
        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Child %s exists, skipping it.</span><span style="color:#e6db74">&#34;</span>, bdata(path));
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// new child so make it
</span><span style="color:#75715e"></span>        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

        Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> calloc(<span style="color:#66d9ef">sizeof</span>(Record), <span style="color:#ae81ff">1</span>);
        check_mem(info);

        <span style="color:#75715e">// set its stat element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat <span style="color:#f92672">=</span> Stats_create();
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);

        <span style="color:#75715e">// set its name element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> bstrcpy(path);
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        <span style="color:#75715e">// do a first sample
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));

        <span style="color:#75715e">// add it to the hashmap
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> Hashmap_set(DATA, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, info);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add data to map.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// only send the for the root part
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(is_root) {
            send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_sample</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    <span style="color:#75715e">// get the info from the hashmap
</span><span style="color:#75715e"></span>    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);
    <span style="color:#66d9ef">int</span> is_root <span style="color:#f92672">=</span> biseq(path, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));
    bstring child_path <span style="color:#f92672">=</span> NULL;

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        <span style="color:#75715e">// if it doesn&#39;t exist then DNE
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span>(is_root) {
            <span style="color:#75715e">// just sample the root like normal
</span><span style="color:#75715e"></span>            Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// need to do some hackery to get the child path
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// for rolling up mean-of-means on it
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// increase the qty on path up one
</span><span style="color:#75715e"></span>            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            <span style="color:#75715e">// get the &#34;child path&#34; (previous path?)
</span><span style="color:#75715e"></span>            child_path <span style="color:#f92672">=</span> bjoin(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path, <span style="color:#f92672">&amp;</span>SLASH);
            <span style="color:#75715e">// get that info from the DATA
</span><span style="color:#75715e"></span>            Record <span style="color:#f92672">*</span>child_info <span style="color:#f92672">=</span> Hashmap_get(DATA, child_path);
            bdestroy(child_path);

            <span style="color:#75715e">// if it exists then sample on it
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>(child_info) {
                <span style="color:#75715e">// info is /logins, child_info is /logins/zed 
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// we want /logins/zed&#39;s mean to be a new sample on /logins
</span><span style="color:#75715e"></span>                Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, Stats_mean(child_info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
            }
            <span style="color:#75715e">// drop the path back to where it was
</span><span style="color:#75715e"></span>            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">-</span><span style="color:#f92672">-</span>;
        }

    }

    <span style="color:#75715e">// do the reply for the mean last
</span><span style="color:#75715e"></span>    bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
    send_reply(send_rb, reply);
    bdestroy(reply);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_delete</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete: %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);
    <span style="color:#66d9ef">int</span> is_root <span style="color:#f92672">=</span> biseq(path, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

    <span style="color:#75715e">// BUG: should just decide that this isn&#39;t scanned 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// but run once, for now just only run on root
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(is_root) {
        Hashmap_delete(DATA, path);

        free(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);
        bdestroy(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        free(info);

        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_mean</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_stddev</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_dump</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump: %s, %s, %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f %f %f %f %ld %f %f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max);

        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_command</span>(<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits, Command <span style="color:#f92672">*</span>cmd)
{
    <span style="color:#75715e">// get the command
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>CREATE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse create: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_create;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>MEAN)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse mean: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_mean;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>SAMPLE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse sample: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_sample;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DUMP)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse dump: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_dump;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DELETE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse delete: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_delete;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>STDDEV)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse stddev: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_stddev;
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse the command.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scan_paths</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Path was not set in command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// save the original path length
</span><span style="color:#75715e"></span>    size_t qty <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty;

    <span style="color:#75715e">// starting at the longest path, shorten it and call
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// for each one:
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(; cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>; cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">-</span><span style="color:#f92672">-</span>) {
        <span style="color:#75715e">// remake the path with / again
</span><span style="color:#75715e"></span>        bstring path <span style="color:#f92672">=</span> bjoin(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path, <span style="color:#f92672">&amp;</span>SLASH);
        <span style="color:#75715e">// call the handler with the path
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler(cmd, send_rb, path);
        <span style="color:#75715e">// if the handler returns != 0 then abort and return that
</span><span style="color:#75715e"></span>        bdestroy(path);

        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// restore path length
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span> qty;
    <span style="color:#66d9ef">return</span> rc;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span><span style="color:#a6e22e">parse_name</span>(bstring name)
{
    <span style="color:#66d9ef">return</span> bsplits(name, <span style="color:#f92672">&amp;</span>SLASH);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    Command cmd <span style="color:#f92672">=</span> {.command <span style="color:#f92672">=</span> NULL};

    <span style="color:#75715e">// split data on line boundaries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits <span style="color:#f92672">=</span> bsplits(data, <span style="color:#f92672">&amp;</span>LINE_SPLIT);
    check(splits <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad data.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// parse it into a command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> parse_command(splits, <span style="color:#f92672">&amp;</span>cmd);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// parse the name into the path we need for scan_paths
</span><span style="color:#75715e"></span>    cmd.path <span style="color:#f92672">=</span> parse_name(cmd.name);
    check(cmd.path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid path.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// scan the path and call the handlers
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> scan_paths(<span style="color:#f92672">&amp;</span>cmd, send_rb);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failure running command against path: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd.name));

    bstrListDestroy(cmd.path);
    bstrListDestroy(splits);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(cmd.path) bstrListDestroy(cmd.path);
    <span style="color:#66d9ef">if</span>(splits) bstrListDestroy(splits);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>recv_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    check_mem(recv_rb);
    check_mem(send_rb);

    <span style="color:#75715e">// keep reading into the recv buffer and sending on send
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(recv_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// read a line from the recv_rb
</span><span style="color:#75715e"></span>        bstring data <span style="color:#f92672">=</span> read_line(recv_rb, LINE_ENDING);
        check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// parse it, close on any protocol errors
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> parse_line(data, send_rb);
        bdestroy(data); <span style="color:#75715e">// cleanup here
</span><span style="color:#75715e"></span>        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse user. Closing.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// and as long as there&#39;s something to send, send it
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(RingBuffer_available_data(send_rb)) {
            write_some(send_rb, client_fd, <span style="color:#ae81ff">1</span>);
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(recv_rb) RingBuffer_destroy(recv_rb);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>()
{
    <span style="color:#75715e">// a more advanced design simply wouldn&#39;t use this
</span><span style="color:#75715e"></span>    DATA <span style="color:#f92672">=</span> Hashmap_create(NULL, NULL);
    check_mem(DATA);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rc <span style="color:#f92672">=</span> setup_data_store();
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex50b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>handler_cb)(<span style="color:#66d9ef">struct</span> Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path);

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Command {
    bstring command;
    bstring name;
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>path;
    bstring number;
    handler_cb handler;
} Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Record {
    bstring name;
    Stats <span style="color:#f92672">*</span>stat;
} Record;

<span style="color:#66d9ef">struct</span> tagbstring OK;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>();

<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span><span style="color:#a6e22e">parse_name</span>(bstring name);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scan_paths</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">echo_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex50b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> LineTest {
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>line;
    bstring result;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>description;
} LineTest;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_line</span>(LineTest test)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    bstring line <span style="color:#f92672">=</span> bfromcstr(test.line);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);

    rc <span style="color:#f92672">=</span> parse_line(line, send_rb);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse line.</span><span style="color:#e6db74">&#34;</span>);

    result <span style="color:#f92672">=</span> RingBuffer_get_all(send_rb);
    check(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Ring buffer empty.</span><span style="color:#e6db74">&#34;</span>);
    check(biseq(result, test.result), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got the wrong output: %s expected %s</span><span style="color:#e6db74">&#34;</span>,
            bdata(result), bdata(test.result));

    bdestroy(line);
    RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// using 1 for tests
</span><span style="color:#75715e"></span>error:

    log_err(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process test %s: got %s</span><span style="color:#e6db74">&#34;</span>, test.line, bdata(result));
    <span style="color:#66d9ef">if</span>(line) bdestroy(line);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_test_lines</span>(LineTest <span style="color:#f92672">*</span>tests, <span style="color:#66d9ef">int</span> count)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        check(attempt_line(tests[i]), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run %s</span><span style="color:#e6db74">&#34;</span>, tests[i].description);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fake_command</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    check(cmd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad cmd.</span><span style="color:#e6db74">&#34;</span>);
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad path.</span><span style="color:#e6db74">&#34;</span>);
    check(send_rb <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad send_rb.</span><span style="color:#e6db74">&#34;</span>);
    check(path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad path given.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_path_parsing</span>()
{
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>result <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> tagbstring slash <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring logins_zed <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/logins/zed</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring command_name <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>path <span style="color:#f92672">=</span> bsplits(<span style="color:#f92672">&amp;</span>logins_zed, <span style="color:#f92672">&amp;</span>slash);
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    Command fake <span style="color:#f92672">=</span> {
        .command <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>command_name,
        .name <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>logins_zed,
        .number <span style="color:#f92672">=</span> NULL,
        .handler <span style="color:#f92672">=</span> fake_command,
        .path <span style="color:#f92672">=</span> path
    };

    result <span style="color:#f92672">=</span> parse_name(<span style="color:#f92672">&amp;</span>logins_zed);
    mu_assert(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse /logins/zed</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> scan_paths(<span style="color:#f92672">&amp;</span>fake, send_rb); 
    mu_assert(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">scan_paths failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /joe 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create joe failed</span><span style="color:#e6db74">&#34;</span>},

    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">2</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run create tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_sample</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring sample1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">100.000000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>sample1, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample zed failed.</span><span style="color:#e6db74">&#34;</span>}
    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">1</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run sample tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> setup_data_store();
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    mu_run_test(test_create);
    mu_run_test(test_sample);
    mu_run_test(test_path_parsing);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Final Review</p>
<h3 id="exercise-51a-storing-the-statistics">Exercise 51a Storing the Statistics</h3>
<p>Project Description</p>
<p>The Plan</p>
<p>Learn to store the statistics to the hard disk.</p>
<p>There are meany issues with this.</p>
<p>The Purpose</p>
<p>To teach you about various problems related to securely storing files.</p>
<p>The Requirements</p>
<p>For this exercise, you'll add two commands for storing to and loading statistics
from a hard drive:</p>
<p>store
If there's a URL, store it to a hard drive.</p>
<p>load
If there are two URLs, load the statistic from the hard drive based on the first URL, and then put it into the second URL that's in memory.</p>
<p>The Requirements</p>
<ol>
<li>If URLs have <code>/</code> characters in them, then that conflicts with the filesystem's use of slashes.  How will you solve this?</li>
<li>If URLs have <code>/</code> characters in them, then someone can use your server to overwrite files on a hard drive by giving paths to them.  How will you solve this?</li>
<li>If you choose to use deeply nested directories, then traversing directories to find files will be very slow.  What will you do here?</li>
</ol>
<p>The Requirements</p>
<ol start="4">
<li>If you choose to use one directory and hash URLs (oops, I gave a hint), then directories with too many files in them are slow.  How will you solve this?</li>
<li>What happens when someone loads a statistic from a hard drive into a URL that already exists?</li>
<li>How will someone running <code>statserve</code> know where the storage should be?</li>
</ol>
<p>The Clues</p>
<p>There are no clues.  You can do this.</p>
<h3 id="exercise-51b-storing-the-statistics">Exercise 51b Storing the Statistics</h3>
<p>Solution</p>
<p>The Plan</p>
<p>Show you how I solved the problem of storing the statistics to disk.</p>
<p>Security Requirements</p>
<ul>
<li>Use <em>realpath</em> to make sure that paths are in one place.</li>
<li>Use <em>BAD</em> encryption to mangle the stored names.</li>
<li>No other security beyond that. Just a demo of the path issue.</li>
</ul>
<p>XTEA Encryption</p>
<ul>
<li>For an extra challenge I decided to &ldquo;hash&rdquo; names with XTEA.</li>
<li><a href="https://en.wikipedia.org/wiki/XTEA">https://en.wikipedia.org/wiki/XTEA</a> for the code.</li>
<li>Normally I wouldn't do this, but wanted to show you XTEA.</li>
<li>Because XTEA if cool and fun, although broken.</li>
<li>DON'T USE XTEA FOR ENCRYPTION.</li>
</ul>
<p>Improvements</p>
<ul>
<li>Let commands set cmd-&gt;path = NULL to indicate non-recursive.</li>
<li>Change <em>echo_server</em> to <em>run_server</em> finally.</li>
<li>Allow a 3rd storage path argument on the command line.</li>
<li>Allow an additional argument to Command.</li>
</ul>
<p>Weirdness</p>
<ul>
<li>Forking means I can't share data between clients without storage.</li>
<li>Storing doesn't happen automatically, only explicitly.</li>
<li>Loading acts as a copy command.</li>
<li>XTEA isn't the best algorithm at all.  Just for fun.</li>
</ul>
<p>How I Did It</p>
<ol>
<li>Create the LOAD and STORE handlers.</li>
<li>Add Command.arg and set those in <em>parse_command</em>.</li>
<li>Move path parsing up to allow non-recursive handling with path = NULL.</li>
<li>Write a <em>sanitize_location</em> and <em>encrypt_armor_name</em> function, test them.</li>
<li>Write <em>handle_store</em> first to allow testing <em>handle_load</em>.</li>
<li>Use <em>open</em> (man 2 open) with O_EXLOCK to get exclusive locks on files.</li>
<li>Using <em>close</em> (man 2 close) should release EXLOCK, but not clear on this.</li>
</ol>
<p>The Code</p>
<p>.\ex51b\statserve</p>
<p>.\ex51b\statserve\bin\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    check(argc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">USAGE: statserve host port store_path</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>store_path <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">3</span>];

    check(run_server(host, port, store_path), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run the echo server.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error:

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex51b\statserve\src\dbg.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define __dbg_h__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef NDEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define debug(M, ...) fprintf(stderr, &#34;DEBUG %s:%d: &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define clean_errno() (errno == 0 ? &#34;None&#34; : strerror(errno))</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_err(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[ERROR] (%s:%d: errno: %s) &#34; M &#34;\n&#34;, __FILE__, __LINE__,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_warn(M, ...) fprintf(stderr,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        &#34;[WARN] (%s:%d: errno: %s) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, clean_errno(), ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define log_info(M, ...) fprintf(stderr, &#34;[INFO] (%s:%d) &#34; M &#34;\n&#34;,\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        __FILE__, __LINE__, ##__VA_ARGS__)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check(A, M, ...) if(!(A)) {\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    log_err(M, ##__VA_ARGS__); errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define sentinel(M, ...)  { log_err(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_mem(A) check((A), &#34;Out of memory.&#34;)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define check_debug(A, M, ...) if(!(A)) { debug(M, ##__VA_ARGS__);\</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    errno=0; goto error; }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex51b\statserve\src\net.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring NL <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CRLF <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd)
{
    <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> fcntl(fd, F_GETFL, <span style="color:#ae81ff">0</span>);
    check(flags <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid flags on nonblock.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> fcntl(fd, F_SETFL, flags <span style="color:#f92672">|</span> O_NONBLOCK);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>addr <span style="color:#f92672">=</span> NULL;

    rc <span style="color:#f92672">=</span> getaddrinfo(host, port, NULL, <span style="color:#f92672">&amp;</span>addr);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to lookup %s:%s</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">int</span> sock <span style="color:#f92672">=</span> socket(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
    check(sock <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot create a socket.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> connect(sock, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, addr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Connect failed.</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> nonblock(sock);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t set nonblocking.</span><span style="color:#e6db74">&#34;</span>);

    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> sock;

error:
    freeaddrinfo(addr);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (RingBuffer_available_data(buffer) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
        buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>start <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> recv(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> read(fd, RingBuffer_starts_at(buffer),
                RingBuffer_available_space(buffer));
    }

    check(rc <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read from fd: %d</span><span style="color:#e6db74">&#34;</span>, fd);

    RingBuffer_commit_write(buffer, rc);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring data <span style="color:#f92672">=</span> RingBuffer_get_all(buffer);

    check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get from the buffer.</span><span style="color:#e6db74">&#34;</span>);
    check(bfindreplace(data, <span style="color:#f92672">&amp;</span>NL, <span style="color:#f92672">&amp;</span>CRLF, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> BSTR_OK,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to replace NL.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span> (is_socket) {
        rc <span style="color:#f92672">=</span> send(fd, bdata(data), blength(data), <span style="color:#ae81ff">0</span>);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> write(fd, bdata(data), blength(data));
    }

    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> blength(data), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write everything to fd: %d.</span><span style="color:#e6db74">&#34;</span>,
            fd);
    bdestroy(data);

    <span style="color:#66d9ef">return</span> rc;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_listen</span>(<span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info)
{
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    check(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid addrinfo.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a socket with the addrinfo
</span><span style="color:#75715e"></span>    sockfd <span style="color:#f92672">=</span> socket(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_family, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_socktype,
            info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_protocol);
    check_debug(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to bind to address. Trying more.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// set the SO_REUSEADDR option on the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to set SO_REUSADDR.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// attempt to bind to it
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> bind(sockfd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addr, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_addrlen);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to find socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// finally listen with a backlog
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> listen(sockfd, BACKLOG);
    check_debug(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to listen to socket.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> sockfd;

error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// default fail value
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>next_p <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> addrinfo addr <span style="color:#f92672">=</span> {
        .ai_family <span style="color:#f92672">=</span> AF_UNSPEC,
        .ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM,
        .ai_flags <span style="color:#f92672">=</span> AI_PASSIVE
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the address info for host and port
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> getaddrinfo(NULL, port, <span style="color:#f92672">&amp;</span>addr, <span style="color:#f92672">&amp;</span>info);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get address info for connect.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// cycle through the available list to find one
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(next_p <span style="color:#f92672">=</span> info; next_p <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL; next_p <span style="color:#f92672">=</span> next_p<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ai_next)
    {
        <span style="color:#75715e">// attempt to listen to each one
</span><span style="color:#75715e"></span>        sockfd <span style="color:#f92672">=</span> attempt_listen(next_p);
        <span style="color:#66d9ef">if</span>(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// either we found one and were able to listen or nothing.
</span><span style="color:#75715e"></span>    check(sockfd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">All possible addresses failed.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">//fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info) freeaddrinfo(info);
    <span style="color:#75715e">// this gets set by the above to either -1 or valid
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> sockfd;
}

bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    <span style="color:#75715e">// not super efficient
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// read a character at a time from the ring buffer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> RingBuffer_available_data(input); i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#75715e">// if the buffer has line ending
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(input<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>buffer[i] <span style="color:#f92672">=</span><span style="color:#f92672">=</span> line_ending) {
            <span style="color:#75715e">// get that much fromt he ring buffer
</span><span style="color:#75715e"></span>            result <span style="color:#f92672">=</span> RingBuffer_gets(input, i);
            check(result, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get line from RingBuffer</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// make sure that we got the right amount
</span><span style="color:#75715e"></span>            check(RingBuffer_available_data(input) <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not enough data in the RingBuffer after reading line.</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#75715e">// and commit it
</span><span style="color:#75715e"></span>            RingBuffer_commit_read(input, <span style="color:#ae81ff">1</span>);
            <span style="color:#66d9ef">break</span>;
        }
    }

    <span style="color:#75715e">// notice this will fail in the cases where we get a set of data
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on the wire that does not have a line ending yet
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> result;
error:
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply)
{
    RingBuffer_puts(send_rb, reply);
}

</code></pre></div><p>.\ex51b\statserve\src\net.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _net_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define BACKLOG 10</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">nonblock</span>(<span style="color:#66d9ef">int</span> fd);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">client_connect</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write_some</span>(RingBuffer <span style="color:#f92672">*</span> buffer, <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> is_socket);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">server_listen</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port);
bstring <span style="color:#a6e22e">read_line</span>(RingBuffer <span style="color:#f92672">*</span>input, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> line_ending);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send_reply</span>(RingBuffer <span style="color:#f92672">*</span>send_rb, bstring reply);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex51b\statserve\src\statserve.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/dbg.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/hashmap.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/wait.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;net.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> tagbstring LINE_SPLIT <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring CREATE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring STDDEV <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring MEAN <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SAMPLE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DUMP <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DELETE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring STORE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">store</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring LOAD <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring OK <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring ERR <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ERR</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring DNE <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">DNE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring EXISTS <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">EXISTS</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">struct</span> tagbstring SLASH <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> LINE_ENDING <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> RB_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>;

Hashmap <span style="color:#f92672">*</span>DATA <span style="color:#f92672">=</span> NULL;
bstring STORE_PATH <span style="color:#f92672">=</span> NULL;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_sigchild</span>(<span style="color:#66d9ef">int</span> sig) {
    sig <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ignore it
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(waitpid(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL, WNOHANG) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    }
}

<span style="color:#75715e">// BUG: this is stupid, use md5
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">encipher</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> num_rounds, uint32_t v[<span style="color:#ae81ff">2</span>], uint32_t <span style="color:#66d9ef">const</span> key[<span style="color:#ae81ff">4</span>]) {
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i;
    uint32_t v0<span style="color:#f92672">=</span>v[<span style="color:#ae81ff">0</span>], v1<span style="color:#f92672">=</span>v[<span style="color:#ae81ff">1</span>], sum<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, delta<span style="color:#f92672">=</span><span style="color:#ae81ff">0x9E3779B9</span>;
    <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> num_rounds; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        v0 <span style="color:#f92672">+</span><span style="color:#f92672">=</span> (((v1 <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">^</span> (v1 <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>)) <span style="color:#f92672">+</span> v1) <span style="color:#f92672">^</span> (sum <span style="color:#f92672">+</span> key[sum <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>]);
        sum <span style="color:#f92672">+</span><span style="color:#f92672">=</span> delta;
        v1 <span style="color:#f92672">+</span><span style="color:#f92672">=</span> (((v0 <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">^</span> (v0 <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>)) <span style="color:#f92672">+</span> v0) <span style="color:#f92672">^</span> (sum <span style="color:#f92672">+</span> key[(sum<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">11</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">3</span>]);
    }
    v[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span>v0; v[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span>v1;
}

<span style="color:#75715e">/// TOTALLY RANDOM! LOL  BUG: not secure
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> uint32_t STORE_KEY[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">18748274</span>, <span style="color:#ae81ff">228374</span>, <span style="color:#ae81ff">193034845</span>, <span style="color:#ae81ff">85726348</span>};
<span style="color:#66d9ef">struct</span> tagbstring FAUX64 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#75715e">// BUG: this all dies
</span><span style="color:#75715e"></span>bstring <span style="color:#a6e22e">encrypt_armor_name</span>(bstring name)
{
    <span style="color:#75715e">// copy the name to encrypt
</span><span style="color:#75715e"></span>    bstring encname <span style="color:#f92672">=</span> bstrcpy(name);
    size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// point the encrypt pointer at it
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: this cast is weird, why?
</span><span style="color:#75715e"></span>    uint32_t <span style="color:#f92672">*</span>v <span style="color:#f92672">=</span> (uint32_t <span style="color:#f92672">*</span>)bdata(encname);

    <span style="color:#75715e">// extend the encname so that it can hold everything
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: use a correct padding algorithm
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(blength(encname) <span style="color:#f92672">%</span> (<span style="color:#66d9ef">sizeof</span>(uint32_t) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        bconchar(encname, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#39;</span>);
    }

    <span style="color:#75715e">// run encipher on this
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: get rid of encipher
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> (size_t)blength(encname) <span style="color:#f92672">/</span> (<span style="color:#66d9ef">sizeof</span>(uint32_t) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>); i<span style="color:#f92672">+</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>) {
        encipher(<span style="color:#ae81ff">1</span>, v<span style="color:#f92672">+</span>i, STORE_KEY);
    }

    <span style="color:#75715e">// do a lame &#34;base 64&#34; kind of thing on it
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: this is NOT the best way, it&#39;s a quick hack to get it working
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// replace with real BASE64 later
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> (size_t)blength(encname); i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#66d9ef">int</span> at <span style="color:#f92672">=</span> encname<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[i] <span style="color:#f92672">%</span> blength(<span style="color:#f92672">&amp;</span>FAUX64);
        encname<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[i] <span style="color:#f92672">=</span> FAUX64.data[at];
    }

    <span style="color:#75715e">// that&#39;s our final hack encrypted name
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> encname;
}

bstring <span style="color:#a6e22e">sanitize_location</span>(bstring base, bstring path)
{
    bstring attempt <span style="color:#f92672">=</span> NULL;
    bstring encpath <span style="color:#f92672">=</span> NULL;

    <span style="color:#75715e">// encrypt armore the name
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: ditch encryption, it was dumb
</span><span style="color:#75715e"></span>    encpath <span style="color:#f92672">=</span> encrypt_armor_name(path);
    check(encpath <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to encrypt path name: %s</span><span style="color:#e6db74">&#34;</span>, bdata(path));

    <span style="color:#75715e">// combine it with the base, this means that we&#39;ve armored the 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// path so we can just append it
</span><span style="color:#75715e"></span>    attempt <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s/%s</span><span style="color:#e6db74">&#34;</span>, bdata(base), bdata(encpath));
    bdestroy(encpath);
    <span style="color:#66d9ef">return</span> attempt;

error:
    <span style="color:#66d9ef">if</span>(encpath) bdestroy(encpath);
    <span style="color:#66d9ef">if</span>(attempt) bdestroy(attempt);
    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_create</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> is_root <span style="color:#f92672">=</span> biseq(path, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> is_root) {
        <span style="color:#75715e">// report if root exists, just skip children
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>EXISTS);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL) {
        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Child %s exists, skipping it.</span><span style="color:#e6db74">&#34;</span>, bdata(path));
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// new child so make it
</span><span style="color:#75715e"></span>        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create: %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));

        Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(Record));
        check_mem(info);

        <span style="color:#75715e">// set its stat element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat <span style="color:#f92672">=</span> Stats_create();
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);

        <span style="color:#75715e">// set its name element
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> bstrcpy(path);
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        <span style="color:#75715e">// do a first sample
</span><span style="color:#75715e"></span>        Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));

        <span style="color:#75715e">// add it to the hashmap
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> Hashmap_set(DATA, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, info);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to add data to map.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// only send the for the root part
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(is_root) {
            send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_sample</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    <span style="color:#75715e">// get the info from the hashmap
</span><span style="color:#75715e"></span>    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);
    <span style="color:#66d9ef">int</span> is_root <span style="color:#f92672">=</span> biseq(path, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number));
    bstring child_path <span style="color:#f92672">=</span> NULL;

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        <span style="color:#75715e">// if it doesn&#39;t exist then DNE
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span>(is_root) {
            <span style="color:#75715e">// just sample the root like normal
</span><span style="color:#75715e"></span>            Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, atof(bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number)));
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// need to do some hackery to get the child path
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// for rolling up mean-of-means on it
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// increase the qty on path up one
</span><span style="color:#75715e"></span>            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            <span style="color:#75715e">// get the &#34;child path&#34; (previous path?)
</span><span style="color:#75715e"></span>            child_path <span style="color:#f92672">=</span> bjoin(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path, <span style="color:#f92672">&amp;</span>SLASH);
            <span style="color:#75715e">// get that info from the DATA
</span><span style="color:#75715e"></span>            Record <span style="color:#f92672">*</span>child_info <span style="color:#f92672">=</span> Hashmap_get(DATA, child_path);
            bdestroy(child_path);

            <span style="color:#75715e">// if it exists then sample on it
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>(child_info) {
                <span style="color:#75715e">// info is /logins, child_info is /logins/zed 
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// we want /logins/zed&#39;s mean to be a new sample on /logins
</span><span style="color:#75715e"></span>                Stats_sample(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, Stats_mean(child_info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
            }
            <span style="color:#75715e">// drop the path back to where it was
</span><span style="color:#75715e"></span>            cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">-</span><span style="color:#f92672">-</span>;
        }

    }

    <span style="color:#75715e">// do the reply for the mean last
</span><span style="color:#75715e"></span>    bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
    send_reply(send_rb, reply);
    bdestroy(reply);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_delete</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    check(path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Should be a recursive command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// BUG: should just decide that this isn&#39;t scanned 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// but run once, for now just only run on root
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        Hashmap_delete(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        free(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);
        bdestroy(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
        free(info);

        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_mean</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mean: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_stddev</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">stddev: %s %s %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat));
        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_dump</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    log_info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump: %s, %s, %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name), bdata(path), bdata(path));
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, path);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        bstring reply <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%f %f %f %f %ld %f %f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                Stats_mean(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                Stats_stddev(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat),
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sum,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>sumsq,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>n,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>min,
                info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>max);

        send_reply(send_rb, reply);
        bdestroy(reply);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_store</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    bstring location <span style="color:#f92672">=</span> NULL;
    bstring from <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name;
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    check(cmd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid command.</span><span style="color:#e6db74">&#34;</span>);
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">store %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));
    check(path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Store is non-recursive.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL) {
        send_reply(send_rb, <span style="color:#f92672">&amp;</span>DNE);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// it exists so we sanitize the name
</span><span style="color:#75715e"></span>        location <span style="color:#f92672">=</span> sanitize_location(STORE_PATH, from);
        check(location, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to sanitize the location.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// open the file we need with EXLOCK
</span><span style="color:#75715e"></span>        fd <span style="color:#f92672">=</span> open(bdata(location), O_WRONLY <span style="color:#f92672">|</span> O_CREAT <span style="color:#f92672">|</span> O_EXLOCK, S_IRWXU);
        check(fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Cannot open file for writing: %s</span><span style="color:#e6db74">&#34;</span>, bdata(location));

        <span style="color:#75715e">// write the Stats part of info to it
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> write(fd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, <span style="color:#66d9ef">sizeof</span>(Stats));
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(Stats), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to write to %s</span><span style="color:#e6db74">&#34;</span>, bdata(location));

        <span style="color:#75715e">// close, which should release the lock
</span><span style="color:#75715e"></span>        close(fd);

        <span style="color:#75715e">// then send OK
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error: 
    <span style="color:#66d9ef">if</span>(fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) close(fd);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_load</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    bstring to <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>arg;
    bstring from <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name;
    bstring location <span style="color:#f92672">=</span> NULL;
    Record <span style="color:#f92672">*</span>info <span style="color:#f92672">=</span> Hashmap_get(DATA, to);
    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    check(path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Load is non-recursive.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">if</span>(info <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL) {
        <span style="color:#75715e">// don&#39;t do it if the target to exists
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>EXISTS);
    } <span style="color:#66d9ef">else</span> {
        location <span style="color:#f92672">=</span> sanitize_location(STORE_PATH, from);
        check(location, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to sanitize location.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// make a new record for the to target
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// TODO: make regular CRUD methods for Record
</span><span style="color:#75715e"></span>        info <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(Record));
        check_mem(info);

        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(Stats));
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat);

        <span style="color:#75715e">// open the file to read from readonly and locked
</span><span style="color:#75715e"></span>        fd <span style="color:#f92672">=</span> open(bdata(location), O_RDONLY <span style="color:#f92672">|</span> O_EXLOCK);
        check(fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Error opening file: %s</span><span style="color:#e6db74">&#34;</span>, bdata(location));

        <span style="color:#75715e">// read into the stats record 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> read(fd, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>stat, <span style="color:#66d9ef">sizeof</span>(Stats));
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(Stats), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to read record at %s</span><span style="color:#e6db74">&#34;</span>, bdata(location));

        <span style="color:#75715e">// close so we release the lock quick
</span><span style="color:#75715e"></span>        close(fd);

        <span style="color:#75715e">// make a copy of to as the name for the info
</span><span style="color:#75715e"></span>        info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> bstrcpy(to);
        check_mem(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);

        <span style="color:#75715e">// put it in the hashmap
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> Hashmap_set(DATA, info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, info);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to ass to data map: %s</span><span style="color:#e6db74">&#34;</span>, bdata(info<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name));

        <span style="color:#75715e">// and send the reply
</span><span style="color:#75715e"></span>        send_reply(send_rb, <span style="color:#f92672">&amp;</span>OK);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">if</span>(fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) close(fd);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_command</span>(<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits, Command <span style="color:#f92672">*</span>cmd)
{
    check(splits <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid split line.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// get the command
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">0</span>];

    <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>CREATE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse create: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_create;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> parse_name(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>MEAN)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse mean: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_mean;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> parse_name(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>SAMPLE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse sample: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>number <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_sample;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> parse_name(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DUMP)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse dump: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_dump;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> parse_name(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>DELETE)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse delete: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_delete;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> NULL;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>STDDEV)) {
        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse stddev: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_stddev;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> parse_name(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>STORE)) {
        <span style="color:#75715e">// store URL
</span><span style="color:#75715e"></span>        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse store: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_store;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> NULL;
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(biseq(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>command, <span style="color:#f92672">&amp;</span>LOAD)) {
        <span style="color:#75715e">// load FROM TO
</span><span style="color:#75715e"></span>        check(splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse load: %d</span><span style="color:#e6db74">&#34;</span>, splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty);
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">1</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>arg <span style="color:#f92672">=</span> splits<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>entry[<span style="color:#ae81ff">2</span>];
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler <span style="color:#f92672">=</span> handle_load;
        cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">=</span> NULL;
    } <span style="color:#66d9ef">else</span> {
        sentinel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse the command.</span><span style="color:#e6db74">&#34;</span>);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scan_paths</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Path was not set in command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// save the original path length
</span><span style="color:#75715e"></span>    size_t qty <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty;

    <span style="color:#75715e">// starting at the longest path, shorten it and call
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// for each one:
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(; cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>; cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty<span style="color:#f92672">-</span><span style="color:#f92672">-</span>) {
        <span style="color:#75715e">// remake the path with / again
</span><span style="color:#75715e"></span>        bstring path <span style="color:#f92672">=</span> bjoin(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path, <span style="color:#f92672">&amp;</span>SLASH);
        <span style="color:#75715e">// call the handler with the path
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>handler(cmd, send_rb, path);
        <span style="color:#75715e">// if the handler returns != 0 then abort and return that
</span><span style="color:#75715e"></span>        bdestroy(path);

        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// restore path length
</span><span style="color:#75715e"></span>    cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">=</span> qty;
    <span style="color:#66d9ef">return</span> rc;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span><span style="color:#a6e22e">parse_name</span>(bstring name)
{
    <span style="color:#66d9ef">return</span> bsplits(name, <span style="color:#f92672">&amp;</span>SLASH);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    Command cmd <span style="color:#f92672">=</span> {.command <span style="color:#f92672">=</span> NULL};

    <span style="color:#75715e">// split data on line boundaries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>splits <span style="color:#f92672">=</span> bsplits(data, <span style="color:#f92672">&amp;</span>LINE_SPLIT);
    check(splits <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad data.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// parse it into a command
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> parse_command(splits, <span style="color:#f92672">&amp;</span>cmd);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse command.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// scan the path and call the handlers
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(cmd.path) { 
        check(cmd.path<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>qty <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Didn&#39;t give a valid URL.</span><span style="color:#e6db74">&#34;</span>);
        rc <span style="color:#f92672">=</span> scan_paths(<span style="color:#f92672">&amp;</span>cmd, send_rb);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failure running recursive command against path: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd.name));
        bstrListDestroy(cmd.path);
    } <span style="color:#66d9ef">else</span> {
        rc <span style="color:#f92672">=</span> cmd.handler(<span style="color:#f92672">&amp;</span>cmd, send_rb, NULL);
        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed running command against path: %s</span><span style="color:#e6db74">&#34;</span>, bdata(cmd.name));
    }

    bstrListDestroy(splits);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(cmd.path) bstrListDestroy(cmd.path);
    <span style="color:#66d9ef">if</span>(splits) bstrListDestroy(splits);
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">client_handler</span>(<span style="color:#66d9ef">int</span> client_fd)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    RingBuffer <span style="color:#f92672">*</span>recv_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(RB_SIZE);

    check_mem(recv_rb);
    check_mem(send_rb);

    <span style="color:#75715e">// keep reading into the recv buffer and sending on send
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(read_some(recv_rb, client_fd, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// read a line from the recv_rb
</span><span style="color:#75715e"></span>        bstring data <span style="color:#f92672">=</span> read_line(recv_rb, LINE_ENDING);
        check(data <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client closed.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// parse it, close on any protocol errors
</span><span style="color:#75715e"></span>        rc <span style="color:#f92672">=</span> parse_line(data, send_rb);
        bdestroy(data); <span style="color:#75715e">// cleanup here
</span><span style="color:#75715e"></span>        check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse user. Closing.</span><span style="color:#e6db74">&#34;</span>);

        <span style="color:#75715e">// and as long as there&#39;s something to send, send it
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>(RingBuffer_available_data(send_rb)) {
            write_some(send_rb, client_fd, <span style="color:#ae81ff">1</span>);
        }
    }

    <span style="color:#75715e">// close the socket
</span><span style="color:#75715e"></span>    rc <span style="color:#f92672">=</span> close(client_fd);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to close the socket.</span><span style="color:#e6db74">&#34;</span>);

error: <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(recv_rb) RingBuffer_destroy(recv_rb);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    exit(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// just exit the child process
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>store_path)
{
    <span style="color:#75715e">// a more advanced design simply wouldn&#39;t use this
</span><span style="color:#75715e"></span>    DATA <span style="color:#f92672">=</span> Hashmap_create(NULL, NULL);
    check_mem(DATA);

    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path <span style="color:#f92672">=</span> realpath(store_path, NULL);
    check(path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to get the real path for storage: %s</span><span style="color:#e6db74">&#34;</span>, store_path);

    STORE_PATH <span style="color:#f92672">=</span> bfromcstr(path);
    free(path);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>store_path)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> sockaddr_in client_addr;
    socklen_t sin_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(client_addr);
    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    rc <span style="color:#f92672">=</span> setup_data_store(store_path);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">struct</span> sigaction sa <span style="color:#f92672">=</span> {
        .sa_handler <span style="color:#f92672">=</span> handle_sigchild,
        .sa_flags <span style="color:#f92672">=</span> SA_RESTART <span style="color:#f92672">|</span> SA_NOCLDSTOP
    };

    check(host <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid host.</span><span style="color:#e6db74">&#34;</span>);
    check(port <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid port.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// create a sigaction that handles SIGCHLD
</span><span style="color:#75715e"></span>    sigemptyset(<span style="color:#f92672">&amp;</span>sa.sa_mask);
    rc <span style="color:#f92672">=</span> sigaction(SIGCHLD, <span style="color:#f92672">&amp;</span>sa, <span style="color:#ae81ff">0</span>);
    check(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup signal handler for child processes.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// listen on the given port and host
</span><span style="color:#75715e"></span>    server_socket <span style="color:#f92672">=</span> server_listen(host, port);
    check(server_socket <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">bind to %s:%s failed.</span><span style="color:#e6db74">&#34;</span>, host, port);

    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        <span style="color:#75715e">// accept the connection
</span><span style="color:#75715e"></span>        client_fd <span style="color:#f92672">=</span> accept(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>sin_size); 
        check(client_fd <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to accept connection.</span><span style="color:#e6db74">&#34;</span>);

        debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Client connected.</span><span style="color:#e6db74">&#34;</span>);

        rc <span style="color:#f92672">=</span> fork();
        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// child process
</span><span style="color:#75715e"></span>            close(server_socket); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// handle the client
</span><span style="color:#75715e"></span>            client_handler(client_fd);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// server process
</span><span style="color:#75715e"></span>            close(client_fd); <span style="color:#75715e">// don&#39;t need this
</span><span style="color:#75715e"></span>        }
    }

error:  <span style="color:#75715e">// fallthrough
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

</code></pre></div><p>.\ex51b\statserve\src\statserve.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">ifndef _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define _statserve_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/stats.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>handler_cb)(<span style="color:#66d9ef">struct</span> Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path);

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Command {
    bstring command;
    bstring name;
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>path;
    bstring number;
    bstring arg;
    handler_cb handler;
} Command;

<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Record {
    bstring name;
    Stats <span style="color:#f92672">*</span>stat;
} Record;

<span style="color:#66d9ef">struct</span> tagbstring OK;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_data_store</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>store_path);

<span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span><span style="color:#a6e22e">parse_name</span>(bstring name);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scan_paths</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parse_line</span>(bstring data, RingBuffer <span style="color:#f92672">*</span>send_rb);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_server</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>port, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>store_path);

bstring <span style="color:#a6e22e">sanitize_location</span>(bstring base, bstring path);

bstring <span style="color:#a6e22e">encrypt_armor_name</span>(bstring name);

<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
</code></pre></div><p>.\ex51b\statserve\tests\statserve_tests.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;minunit.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;statserve.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/bstrlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;lcthw/ringbuffer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> LineTest {
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>line;
    bstring result;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>description;
} LineTest;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">attempt_line</span>(LineTest test)
{
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    bstring result <span style="color:#f92672">=</span> NULL;

    bstring line <span style="color:#f92672">=</span> bfromcstr(test.line);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);

    rc <span style="color:#f92672">=</span> parse_line(line, send_rb);
    check(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse line.</span><span style="color:#e6db74">&#34;</span>);
    result <span style="color:#f92672">=</span> RingBuffer_get_all(send_rb);
    check(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Ring buffer empty.</span><span style="color:#e6db74">&#34;</span>);
    check(biseq(result, test.result), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got the wrong output: %s expected %s</span><span style="color:#e6db74">&#34;</span>,
            bdata(result), bdata(test.result));

    bdestroy(line);
    RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// using 1 for tests
</span><span style="color:#75715e"></span>error:

    log_err(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to process test %s: got %s</span><span style="color:#e6db74">&#34;</span>, test.line, bdata(result));
    <span style="color:#66d9ef">if</span>(line) bdestroy(line);
    <span style="color:#66d9ef">if</span>(send_rb) RingBuffer_destroy(send_rb);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">run_test_lines</span>(LineTest <span style="color:#f92672">*</span>tests, <span style="color:#66d9ef">int</span> count)
{
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        check(attempt_line(tests[i]), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run %s</span><span style="color:#e6db74">&#34;</span>, tests[i].description);
    }

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fake_command</span>(Command <span style="color:#f92672">*</span>cmd, RingBuffer <span style="color:#f92672">*</span>send_rb, bstring path)
{
    check(cmd <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad cmd.</span><span style="color:#e6db74">&#34;</span>);
    check(cmd<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad path.</span><span style="color:#e6db74">&#34;</span>);
    check(send_rb <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad send_rb.</span><span style="color:#e6db74">&#34;</span>);
    check(path <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Bad path given.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
error:
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_path_parsing</span>()
{
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>result <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> tagbstring slash <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring logins_zed <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/logins/zed</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring command_name <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dump</span><span style="color:#e6db74">&#34;</span>);
    RingBuffer <span style="color:#f92672">*</span>send_rb <span style="color:#f92672">=</span> RingBuffer_create(<span style="color:#ae81ff">1024</span>);
    <span style="color:#66d9ef">struct</span> bstrList <span style="color:#f92672">*</span>path <span style="color:#f92672">=</span> bsplits(<span style="color:#f92672">&amp;</span>logins_zed, <span style="color:#f92672">&amp;</span>slash);
    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    Command fake <span style="color:#f92672">=</span> {
        .command <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>command_name,
        .name <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>logins_zed,
        .number <span style="color:#f92672">=</span> NULL,
        .handler <span style="color:#f92672">=</span> fake_command,
        .path <span style="color:#f92672">=</span> path
    };

    result <span style="color:#f92672">=</span> parse_name(<span style="color:#f92672">&amp;</span>logins_zed);
    mu_assert(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to parse /logins/zed</span><span style="color:#e6db74">&#34;</span>);

    rc <span style="color:#f92672">=</span> scan_paths(<span style="color:#f92672">&amp;</span>fake, send_rb); 
    mu_assert(rc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">scan_paths failed.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_create</span>()
{
    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /joe 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create joe failed</span><span style="color:#e6db74">&#34;</span>},

    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">2</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run create tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_sample</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring sample1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">100.000000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>sample1, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">sample zed failed.</span><span style="color:#e6db74">&#34;</span>}
    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">1</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run sample tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_store_load</span>()
{
    LineTest tests[] <span style="color:#f92672">=</span> {
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete /zed</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create /zed 100</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">create zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">store /zed</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">store zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load /zed /sam</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load zed failed</span><span style="color:#e6db74">&#34;</span>},
        {.line <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">delete /sam</span><span style="color:#e6db74">&#34;</span>, .result <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>OK, .description <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load zed failed</span><span style="color:#e6db74">&#34;</span>},
    };

    mu_assert(run_test_lines(tests, <span style="color:#ae81ff">3</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to run sample tests.</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_encrypt_armor_name</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring test1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/logins</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring expect1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">vtmTmzNI</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring test2 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">../../../../../../../../etc/passwd</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring expect2 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pVOBpFjHEIhB7cuT3BGUvyZGn3lvyj226mgggggg</span><span style="color:#e6db74">&#34;</span>);

    bstring result <span style="color:#f92672">=</span> encrypt_armor_name(<span style="color:#f92672">&amp;</span>test1);
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got encrypted name %s</span><span style="color:#e6db74">&#34;</span>, bdata(result));
    mu_assert(biseq(result, <span style="color:#f92672">&amp;</span>expect1), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to encrypt test2.</span><span style="color:#e6db74">&#34;</span>);
    bdestroy(result);

    result <span style="color:#f92672">=</span> encrypt_armor_name(<span style="color:#f92672">&amp;</span>test2);
    debug(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Got encrypted name %s</span><span style="color:#e6db74">&#34;</span>, bdata(result));
    mu_assert(biseq(result, <span style="color:#f92672">&amp;</span>expect2), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to encrypt test2.</span><span style="color:#e6db74">&#34;</span>);
    bdestroy(result);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">test_path_sanitize_armor</span>()
{
    <span style="color:#66d9ef">struct</span> tagbstring base <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">struct</span> tagbstring test1 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/somepath/here/there</span><span style="color:#e6db74">&#34;</span>);
    bstring encname <span style="color:#f92672">=</span> encrypt_armor_name(<span style="color:#f92672">&amp;</span>test1);
    bstring expect <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s/%s</span><span style="color:#e6db74">&#34;</span>, bdata(<span style="color:#f92672">&amp;</span>base), bdata(encname));
    <span style="color:#66d9ef">struct</span> tagbstring test2 <span style="color:#f92672">=</span> bsStatic(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">../../../../../../../../etc/passwd</span><span style="color:#e6db74">&#34;</span>);

    bstring result <span style="color:#f92672">=</span> sanitize_location(<span style="color:#f92672">&amp;</span>base, <span style="color:#f92672">&amp;</span>test1);
    mu_assert(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to sanitize path.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(biseq(result, expect), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">failed to sanitize test1</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// this should be pulled up into a tester function
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// BUG: just get rid of this and use md5
</span><span style="color:#75715e"></span>    encname <span style="color:#f92672">=</span> encrypt_armor_name(<span style="color:#f92672">&amp;</span>test2);
    expect <span style="color:#f92672">=</span> bformat(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s/%s</span><span style="color:#e6db74">&#34;</span>, bdata(<span style="color:#f92672">&amp;</span>base), bdata(encname));
    result <span style="color:#f92672">=</span> sanitize_location(<span style="color:#f92672">&amp;</span>base, <span style="color:#f92672">&amp;</span>test2);
    mu_assert(result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> NULL, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to sanitize path.</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(biseq(result, expect), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">failed to sanitize test1</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#66d9ef">return</span> NULL;
}

<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">all_tests</span>()
{
    mu_suite_start();

    <span style="color:#66d9ef">int</span> rc <span style="color:#f92672">=</span> setup_data_store(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp</span><span style="color:#e6db74">&#34;</span>);
    mu_assert(rc <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Failed to setup the data store.</span><span style="color:#e6db74">&#34;</span>);

    mu_run_test(test_path_parsing);
    mu_run_test(test_encrypt_armor_name);
    mu_run_test(test_path_sanitize_armor);
    mu_run_test(test_create);
    mu_run_test(test_sample);
    mu_run_test(test_store_load);

    <span style="color:#66d9ef">return</span> NULL;
}

RUN_TESTS(all_tests);

</code></pre></div><p>Final Review</p>

    </div>

    <div class="toc toc-fixed" >
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#exercise-48a-a-simple-network-server">Exercise 48a A Simple Network Server:</a></li>
        <li><a href="#exercise-48b-a-simple-network-server">Exercise 48b A Simple Network Server:</a></li>
        <li><a href="#exercise-49a-a-statistics-server">Exercise 49a A Statistics Server</a></li>
        <li><a href="#exercise-49b-a-statistics-server">Exercise 49b A Statistics Server:</a></li>
        <li><a href="#exercise-50a-routing-the-statistics">Exercise 50a Routing The Statistics</a></li>
        <li><a href="#exercise-50b-routing-the-statistics">Exercise 50b Routing the Statistics</a></li>
        <li><a href="#exercise-51a-storing-the-statistics">Exercise 51a Storing the Statistics</a></li>
        <li><a href="#exercise-51b-storing-the-statistics">Exercise 51b Storing the Statistics</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

</div>

    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/coding/c/lcthw-lectures.3/" title="C Lecture - 3"> <i class="fa fa-chevron-left"></i><label>C Lecture - 3</label></a>
    <a class="nav nav-next" href="/coding/c-sharp/" title="C#" style="margin-right: 0px;"><label>C#</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

    

    
  </div>


	<div>


  
    
  



	</div>
</footer>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>


<link href="/css/github.css" rel="stylesheet">
<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script src="/theme-flex/script.js"></script>


    

    
    

    
  </body>
</html>